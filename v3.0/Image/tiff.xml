<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://peachfuzzer.com/2012/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://peachfuzzer.com/2012/Peach /peach/peach.xsd"  
       author="Deja Vu Security, LLC" description="TIFF PIT" version="0.0.2">
  <!-- Copyright (c) Deja Vu Security, LLC 2013 -->

  <Defaults>
    <Number endian="little" signed="false" />
  </Defaults>

  <!-- Base Entry Types -->

  <DataModel name="DirectoryEntry">
    <Number name="Tag" size="16" signed="false" />
    <Number name="Type" size="16" />
    <Block name="Body">
      <Number name="Count" size="32" signed="false" >
        <Relation type="count" of="Value"/>
      </Number> 
      <Block name="ValueBlock" length="4">
        <Block name="Value" minOccurs="1"/>          <!-- Overwrite -->
        <Padding name="Pad" alignment="32" />
      </Block>  
    </Block>
  </DataModel>

  <DataModel name="DirectoryEntryPointer" ref="DirectoryEntry">
    <Block name="Body">
      <Number name="Count" size="32" signed="false">
        <Relation type="count" of="Value"/>
      </Number>
      <Number name="Pointer" size="32" signed="false">
        <Relation type="offset" of="ValueBlock" />
      </Number>
      <Block name="ValueBlock">
        <Placement after="TailPlace" /> <!--TODO Should this matter that its after?-->
        <Block name="Value" minOccurs="1" /> <!-- Overwrite -->
      </Block>
    </Block>  
  </DataModel>

  <!-- Entry Types -->
  
  <DataModel name="ByteEntry">
    <Choice>
      <Block name="C1" ref="DirectoryEntry">
        <Number name="Type" size="16" value="1" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="1" token="true" />
        <Number name="Body.ValueBlock.Value" size="8" signed="false" />
      </Block>
      <Block name="C2" ref="DirectoryEntry">
        <Number name="Type" size="16" value="1" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="2" token="true" />
        <Number name="Body.ValueBlock.Value" size="8" signed="false" occurs="2" />
      </Block>
      <Block name="C3" ref="DirectoryEntry">
        <Number name="Type" size="16" value="1" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="3" token="true" />
        <Number name="Body.ValueBlock.Value" size="8" signed="false" occurs="3"/>
      </Block>
      <Block name="C4" ref="DirectoryEntry">
        <Number name="Type" size="16" value="1" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="4" token="true" />
        <Number name="Body.ValueBlock.Value" size="8" signed="false" occurs="4"/>
      </Block>
      <Block name="CX" ref="DirectoryEntryPointer">
        <Number name="Type" size="16" value="1" token="true" />
        <Number name="Body.ValueBlock.Value" size="8" signed="false" minOccurs="5" />
      </Block>
    </Choice>
  </DataModel>


  <DataModel name="AsciiEntry">
    <Choice>
      <Block name="C1" ref="DirectoryEntry">
        <Number name="Type" size="16" value="2" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="1" token="true" />
        <String name="Body.ValueBlock.Value" length="1" nullTerminated="true"/>
      </Block>
      <Block name="C2" ref="DirectoryEntry">
        <Number name="Type" size="16" value="2" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="2" token="true" />
        <String name="Body.ValueBlock.Value" length="2" nullTerminated="true"/>
      </Block>
      <Block name="C3" ref="DirectoryEntry">
        <Number name="Type" size="16" value="2" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="3" token="true" />
        <String name="Body.ValueBlock.Value" length="3" nullTerminated="true"/>
      </Block>
      <Block name="C4" ref="DirectoryEntry">
        <Number name="Type" size="16" value="2" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="4" token="true" />
        <String name="Body.ValueBlock.Value" length="4" nullTerminated="true"/>
      </Block>
      <Block name="CX" ref="DirectoryEntryPointer">
        <Number name="Type" size="16" value="2" token="true" />
        <Number name="Count" size="16" signed="false">
          <Relation type="size" of="Value"/>
        </Number>
        <String name="Body.ValueBlock.Value" nullTerminated="true" />
      </Block>
    </Choice>
  </DataModel>


  <DataModel name="ShortEntry">
    <Choice>
      <Block name="C1" ref="DirectoryEntry">
        <Number name="Type" size="16" value="3" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="1" token="true" />
        <Number name="Body.ValueBlock.Value" size="16" signed="false" />
      </Block>
      <Block name="C2" ref="DirectoryEntry">
        <Number name="Type" size="16" value="3" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="2" token="true" />
        <Number name="Body.ValueBlock.Value" size="16" signed="false" occurs="2" />
      </Block>
      <Block name="CX" ref="DirectoryEntryPointer">
        <Number name="Type" size="16" value="3" token="true" />
        <Number name="Body.ValueBlock.Value" size="16" signed="false" minOccurs="3" />
      </Block>
    </Choice>
  </DataModel>


  <DataModel name="LongEntry">
    <Choice>
      <Block name="C1" ref="DirectoryEntry">
        <Number name="Type" size="16" value="4" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="1" token="true" />
        <Number name="Body.ValueBlock.Value" size="32" signed="false" />
      </Block>
      <Block name="CX" ref="DirectoryEntryPointer">
        <Number name="Type" size="16" value="4" token="true" />
        <Number name="Body.ValueBlock.Value" size="32" signed="false" minOccurs="2" />
      </Block>
    </Choice>
  </DataModel>


  <DataModel name="RationalEntry">
    <Block name="CX" ref="DirectoryEntryPointer">
      <Number name="Type" size="16" value="5" token="true" />
      <Block name="Body.ValueBlock.Value" minOccurs="1">
        <Number name="Numerator" size="32" signed="false" />
        <Number name="Denominator" size="32" signed="false" />
      </Block>
    </Block>
  </DataModel>


  <!-- TIFF 6.0 Entry Types -->
  
  <DataModel name="SByteEntry">
    <Choice>
      <Block name="C1" ref="DirectoryEntry">
        <Number name="Type" size="16" value="6" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="1" token="true" />
        <Number name="Body.ValueBlock.Value" size="8" signed="true" />
      </Block>
      <Block name="C2" ref="DirectoryEntry">
        <Number name="Type" size="16" value="6" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="2" token="true" />
        <Number name="Body.ValueBlock.Value" size="8" signed="true" occurs="2" />
      </Block>
      <Block name="C3" ref="DirectoryEntry">
        <Number name="Type" size="16" value="6" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="3" token="true" />
        <Number name="Body.ValueBlock.Value" size="8" signed="true" occurs="3"/>
      </Block>
      <Block name="C4" ref="DirectoryEntry">
        <Number name="Type" size="16" value="6" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="4" token="true" />
        <Number name="Body.ValueBlock.Value" size="8" signed="true" occurs="4"/>
      </Block>
      <Block name="CX" ref="DirectoryEntryPointer">
        <Number name="Type" size="16" value="6" token="true" />
        <Number name="Body.ValueBlock.Value" size="8" signed="true" minOccurs="5" />
      </Block>
    </Choice>
  </DataModel>


  <DataModel name="UndefinedEntry">
    <Choice>
      <Block name="C1" ref="DirectoryEntry">
        <Number name="Type" size="16" value="7" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="1" token="true" />
        <Blob name="Body.ValueBlock.Value" length="1" />
      </Block>
      <Block name="C2" ref="DirectoryEntry">
        <Number name="Type" size="16" value="7" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="2" token="true" />
        <Blob name="Body.ValueBlock.Value" length="1" occurs="2" />
      </Block>
      <Block name="C3" ref="DirectoryEntry">
        <Number name="Type" size="16" value="7" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="3" token="true" />
        <Blob name="Body.ValueBlock.Value" length="1" occurs="3"/>
      </Block>
      <Block name="C4" ref="DirectoryEntry">
        <Number name="Type" size="16" value="7" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="4" token="true" />
        <Blob name="Body.ValueBlock.Value" length="1" occurs="4"/>
      </Block>
      <Block name="CX" ref="DirectoryEntryPointer">
        <Number name="Type" size="16" value="7" token="true" />
        <Blob name="Body.ValueBlock.Value" length="1" minOccurs="5" />
      </Block>
    </Choice>
  </DataModel>


  <DataModel name="SShortEntry">
    <Choice>
      <Block name="C1" ref="DirectoryEntry">
        <Number name="Type" size="16" value="8" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="1" token="true" />
        <Number name="Body.ValueBlock.Value" size="16" signed="true" />
      </Block>
      <Block name="C2" ref="DirectoryEntry">
        <Number name="Type" size="16" value="8" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="2" token="true" />
        <Number name="Body.ValueBlock.Value" size="16" signed="true" occurs="2" />
      </Block>
      <Block name="CX" ref="DirectoryEntryPointer">
        <Number name="Type" size="16" value="8" token="true" />
        <Number name="Body.ValueBlock.Value" size="16" signed="true" minOccurs="3" />
      </Block>
    </Choice>
  </DataModel>


  <DataModel name="SLongEntry">
    <Choice>
      <Block name="C1" ref="DirectoryEntry">
        <Number name="Type" size="16" value="9" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="1" token="true" />
        <Number name="Body.ValueBlock.Value" size="32" signed="true" />
      </Block>
      <Block name="CX" ref="DirectoryEntryPointer">
        <Number name="Type" size="16" value="9" token="true" />
        <Number name="Body.ValueBlock.Value" size="32" signed="true" minOccurs="2" />
      </Block>
    </Choice>
  </DataModel>


  <DataModel name="SRationalEntry">
    <Block name="CX" ref="DirectoryEntryPointer">
      <Number name="Type" size="16" value="10" token="true" />
      <Block name="Body.ValueBlock.Value" minOccurs="1">
        <Number name="Numerator" size="32" signed="true" />
        <Number name="Denominator" size="32" signed="true" />
      </Block>
    </Block>
  </DataModel>


  <DataModel name="FloatEntry">
    <Choice>
      <Block name="C1" ref="DirectoryEntry">
        <Number name="Type" size="16" value="11" token="true" />
        <Number name="Body.Count" size="32" signed="false" value="1" token="true" />
        <Number name="Body.ValueBlock.Value" size="32" signed="false" />
      </Block>
      <Block name="CX" ref="DirectoryEntryPointer">
        <Number name="Type" size="16" value="11" token="true" />
        <Number name="Body.ValueBlock.Value" size="32" signed="true" minOccurs="2" />
      </Block>
    </Choice>
  </DataModel>


  <DataModel name="DoubleEntry">
    <Block name="CX" ref="DirectoryEntryPointer">
      <Number name="Type" size="16" value="12" token="true" />
      <Number name="Body.ValueBlock.Value" size="64" signed="false" minOccurs="1"/>
    </Block>
  </DataModel>

  <!-- Tags -->

  
  <!-- Entry Choices TODO replace with tag specific-->
  <DataModel name="DirectoryEntryOptions">
    <Choice>
      <Block ref="ByteEntry" />
      <Block ref="AsciiEntry" />
      <Block ref="ShortEntry" />
      <Block ref="LongEntry" />
      <Block ref="RationalEntry" />
      <Block ref="SByteEntry" />
      <Block ref="UndefinedEntry" />
      <Block ref="SShortEntry" />
      <Block ref="SLongEntry" />
      <Block ref="SRationalEntry" />
      <Block ref="FloatEntry" />
      <Block ref="DoubleEntry" />
    </Choice>
  </DataModel>


  <DataModel name="ImageFileDirectoryChunk">
    <Placement before="TailPlace" />
    <Number name="EntryCount" size="16" signed="false">
      <Relation type="count" of="IFDEntry"/>
    </Number>
    <Block name="IFDEntry" ref="DirectoryEntryOptions" minOccurs="1" />
    <Choice name="ListChoice">
      <Number name="EndofList" value="0" size="32" signed="false" token="true"/>
      <Block name="NextItem">
        <Number name="NextPointer" size="32" signed="false">
          <Relation type="offset" of="NextImageFileDirectory" />
        </Number>
        <Block name="NextImageFileDirectory" />
      </Block>
    </Choice>
  </DataModel>

  <DataModel name="ImageFileDirectory" ref="ImageFileDirectoryChunk">
    <Block name="ListChoice.NextItem.NextImageFileDirectory" ref="ImageFileDirectoryChunk" />
  </DataModel>



  <!-- MAIN TIFF DATA MODEL -->
  <DataModel name="TIFF">    
    <Choice name="EndianessChoice">
      <Blob name="LittleEndian" length="2" value="II" token="true"/>
      <!--Blob name="BigEndian" length="2" value="MM" token="true"/-->
    </Choice>
    
    <Number name="Magic" value="42" token="true" size="16"/>

    <Number name="IFDOffset" size="32" >
      <Relation type="offset" of="TheIFD" />
    </Number>

    <Block name="TheIFD" ref="ImageFileDirectory" />

    

    <Blob name="ImageData" minOccurs="1" >
      <!--Relation type="count"  from="ImageCount" /-->
      <!--Relation type="offset" from="ImageOffset"/-->
      <!--Relation type="size"   from="StripeSize" /-->
    </Blob>
    
    <Block name="TailPlace" /><!--TODO why cant this be above ImageData?-->

  </DataModel>



  <!-- STATE MODEL SECTION -->
  <StateModel name="StateModel" initialState="Initial">
    <State name="Initial">
      <Action name="WriteFileFromSample" type="output" publisher="writer">
        <DataModel name="Tiff" ref="TIFF" />
        <Data name="data" fileName="##Path##/_Common/Samples/Image/##Seed##" />
      </Action>

      <Action name="CloseFile"  type="close" publisher="writer" />
      <Action name="Launch" type="call" method="FuzzMe" publisher="Peach.Agent" />
    </State>
  </StateModel>


  <!-- ***************
       AGENT SECTION  
      *************** -->

   <Agent name="LinuxAgent">
    <Monitor class="LinuxCrashMonitor"/>
    <Monitor class="Process">
      <Param name="Executable" value="##Target##"/>
      <Param name="StartOnCall" value="FuzzMe"/>
      <Param name="Arguments" value="fuzzed.tif"/>
      <Param name="CpuKill" value="true"/>
    </Monitor>
  </Agent>
  
  <Agent name="WinAgent">
    <Monitor class="WindowsDebugger">
      <Param name="CommandLine" value="##Target## fuzzed.tif"/>
      <Param name="StartOnCall" value="FuzzMe"/>
      <Param name="CpuKill" value="true"/>
    </Monitor>
  </Agent>


  <!-- **************
        TEST SECTION  
       ************** -->
  <Test name="Default">

    <Agent ref="##Agent##"/>
    <StateModel ref="StateModel" />

    <Publisher name="writer" class="file.FileWriter">
      <Param name="FileName" value="fuzzed.tif" />
    </Publisher>

    <!-- Command Line Launcher: Win/Lin/OSX  With Debugger -->
    <!--Publisher name="launch" class="process.DebuggerLauncher"/-->

    <!-- GUI Launcher: WINDOWS ONLY -->
    <!--
     <Publisher name="launch" class="process.DebuggerLauncherGui"> 
      <Param name="WindowName" value="GUI Window Name" /> 
     </Publisher> 
     -->
    <Strategy class="##Strategy##"/>

    <Logger class="File">
      <Param name="Path" value="##LoggerPath##"/>
    </Logger>

  </Test>
</Peach>
