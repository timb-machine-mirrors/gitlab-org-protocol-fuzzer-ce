<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://phed.org/2012/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://phed.org/2012/Peach /peach/peach.xsd" author="Deja vu Security" version="1">

	<!-- IMPORTS SECTION -->
	<Import import="math"/>

	<!-- DATA MODEL SECTION -->
	<!-- Data Sub Block  -->
	<DataModel name="DataSubBlock">
		<Number name="BlockSize" size="8" signed="false" constraint="str(element.DefaultValue) != '0'">
			<Relation type="size" of="Data" />
		</Number>
		<Block name="Data">
			<Blob name="dataDefault" />
		</Block>
	</DataModel>

  <!-- Block Terminator -->
	<DataModel name="BlockTerminator">
		<Blob valueType="hex" value='0' length='1' token="true"/>
	</DataModel>


  <!-- Extension Base -->
	<DataModel name="ExtensionBase">
		<Blob name="ExtensionIntroducer" valueType="hex" length="1" value="21" token="true"/>
		<Blob name="Label" valueType="hex" length="1"/>
		<Block name="FirstSubBlock" ref="DataSubBlock" />
		<Block name="AdditionalSubBlocks" minOccurs="0" ref="DataSubBlock" />
		<Block name="Terminator" ref="BlockTerminator"/>
	</DataModel>

  <!-- Graphic Control Extension -->
	<DataModel name="GraphicControlExtension" ref="ExtensionBase">
		<Blob name="Label" valueType="hex" value="F9" length="1" token="true"/>
		<Block name="FirstSubBlock" ref="DataSubBlock">
			<Block name="Data">
				<!--<Choice>
					<Block>
						<Flags name="GraphicControlExtFlags" size="8">
							<Flag name="Reserved" position="5" size="3"/>
							<Flag name="DisposalMethod" position="2" size="3"/>
							<Flag name="UserInputFlag" position="1" size="1"/>
							<Flag name="TransparentColorFlag" position="0" size="1" value="1" token="true"/>
						</Flags>
						<Number name="DelayTime" size="16" signed="false"/>
						<Block name="TransparantColorIndex" constraint="str(element.parent.find('TransparentColorFlag').DefaultValue) == '1'">
							<Number name="TransparentColorIndex" size="8" signed="false" />
						</Block>
					</Block>-->
					<Block>
						<Flags name="GraphicControlExtFlags" size="8">
							<Flag name="Reserved" position="5" size="3"/>
							<Flag name="DisposalMethod" position="2" size="3"/>
							<Flag name="UserInputFlag" position="1" size="1"/>
							<Flag name="TransparentColorFlag" position="0" size="1" value="0"/>
						</Flags>
						<Number name="DelayTime" size="16" signed="false"/>
						<!--TODO check if this is still included when TransparentColorFlag is 0 -->
						<Number name="TransparentColorIndex" size="8" signed="false" /> 
					</Block>
				<!--</Choice>-->
			</Block>
		</Block>
	</DataModel>

  <!-- Comment Extension -->
	<DataModel name="CommentExtension" ref="ExtensionBase">
		<Blob name="Label" valueType="hex" value="FE" token="true"/>
	</DataModel>

  <!-- Plain Text Extension -->
	<DataModel name="PlainTextExtension" ref="ExtensionBase">
		<Blob name="Label" valueType="hex" value="01" token="true"/>
		<Block name="FirstSubBlock" ref="DataSubBlock">
			<Block name="Data">
				<Number name="TextGridLeftPosition" size="16" signed="false"/>
				<Number name="TextGridTopPosition" size="16" signed="false"/>
				<Number name="TextGridWidth" size="16" signed="false"/>
				<Number name="TextGridHeight" size="16" signed="false"/>
				<Number name="CharacterCellWidth" size="8" signed="false"/>
				<Number name="CharacterCellHeight" size="8" signed="false"/>
				<Number name="TextForegroundColorIndex" size="8" signed="false"/>
				<Number name="TextBackgroundColorIndex" size="8" signed="false"/>
			</Block>
		</Block>
	</DataModel>

  <!-- Application Extension -->
	<DataModel name="ApplicationExtension" ref="ExtensionBase">
		<Blob name="Label" valueType="hex" value="FF" token="true"/>
		<Block name="FirstSubBlock" ref="DataSubBlock">
			<Block name="Data">
				<String name="ApplicationIdentifier" length="8"/>
				<Blob name="ApplicationAuthenticationCode" length="3"/>
			</Block>
		</Block>
	</DataModel>




  <!-- Table Based Image -->
	<DataModel name="TableBasedImage">
		<Block name="TheImageDescriptor" minOccurs="0">
			<Blob name="Seperator" token="true" valueType="hex" value="2C" length="1"/>
			<Number name="ImageLeftPosition" signed="false" size="16"/>
			<Number name="ImageTopPosition" signed="false" size="16"/>
			<Number name="ImageWidth" signed="false" size="16"/>
			<Number name="ImageHeight" signed="false" size="16"/>

			<Choice>
				<Block>
					<Flags name="PackedFields" size="8" endian="little">
						<Flag name="LocalColorTableFlag" position="7" size="1" value="1" token="true"/>
						<Flag name="InterlaceFlag" position="6" size="1"/>
						<Flag name="SortFlag" position="5" size="1"/>
						<Flag name="Reserved" position="3" size="2"/>
						<Flag name="SizeofLocalColorTable" position="0" size="3">
							<Relation type="count" of="ColorTripples" expressionGet="pow( 2, count + 1 )"
								expressionSet="int(math.log(count,2)-1)" />
						</Flag>
					</Flags>
					<Block name="LocalColorTable" >
						<Block name="ColorTripples" minOccurs="1">
							<Number name="R" size="8" signed="false"/>
							<Number name="G" size="8" signed="false"/>
							<Number name="B" size="8" signed="false"/>
						</Block>
					</Block>
				</Block>
				<Block>
					<Flags name="PackedFields" size="8" endian="little">
						<Flag name="LocalColorTableFlag" position="7" size="1" value="0" token="true"/>
						<Flag name="InterlaceFlag" position="6" size="1"/>
						<Flag name="SortFlag" position="5" size="1"/>
						<Flag name="Reserved" position="3" size="2"/>
						<Flag name="SizeofLocalColorTable" position="0" size="3" value="0"/>
					</Flags>
				</Block>
			</Choice>
		</Block>
    
		<Block name="TableBasedImageData">
			<Number name="LZWMinimumCodeSize" size="8" signed="false"/>
			<Block name="DataSubBlock" minOccurs="1" ref="DataSubBlock" />
			<Block name="Terminator" ref="BlockTerminator"/>
		</Block>
	</DataModel>

	<!-- MAIN GIF Data Model --> 
	<DataModel name="GIF">
		<!-- Header -->
		<Block name="Header">
			<String name="Signature" token="true" value="GIF" />
			<String name="GIFSigChoice" length="3" value="89a">
				<Hint name="ValidValues" value="87a;89a" />
			</String>
		</Block>
		
		<!-- Logical Screen Descriptor -->
		<Block name="LogicalScreenDescriptor" >
			<Number name="LogicalScreenWidth" size="16" signed="false"/>
			<Number name="LogicalScreenHeight" size="16" signed="false"/>

			<Flags name="PackedFields" size="8">
				<Flag name="GlobalColorTableFlag" position="7" size="1"/>
				<Flag name="ColorResolution" position="4" size="3"/>
				<Flag name="SortFlag" position="3" size="1"/>
				<Flag name="SizeofGlobalColorTable" position="0" size="3">
					<Relation type="count" of="ColorTripples" expressionGet="int(math.pow(2, count+1))" expressionSet="int(math.log(count,2)-1)"/>
				</Flag>
			</Flags>
			<Number name="BackgroundColorIndex" size="8"/>
			<Number name="PixelAspectRatio" size="8"/>
		</Block>
		
		<Block name="GlobalColorTable">
			<Block name="ColorTripples" minOccurs="1">
				<Number name="R" size="8" signed="false"/>
				<Number name="G" size="8" signed="false"/>
				<Number name="B" size="8" signed="false"/>
			</Block>
		</Block>

		<Block name="EveryThingElse" minOccurs="0">
			<Choice name="DataChoice">
				<Block name="TheGraphicsBlock">
					<Block name="TheApplicationExtension" ref="ApplicationExtension" minOccurs="0"/>
					<Block name="TheGraphicControlExtension" ref="GraphicControlExtension" minOccurs="0" maxOccurs="1"/>
					<Block name="GraphicRenderingBlock">
						<Choice name="RenderBlockChoice">
							<Block name="TheTableBasedImage" ref="TableBasedImage"/>
							<Block name="ThePlainTextExtension" ref="PlainTextExtension"/>
						</Choice>
					</Block>
				</Block>
				<Block name="TheSpecialPurposeBlock">
					<Choice name="SpecialBlockChoice">
						<Block name="TheApplicationExtension" ref="ApplicationExtension"/>
						<Block name="TheCommentExtension" ref="CommentExtension"/>
					</Choice>
				</Block>
			</Choice>
		</Block>
		
		<Block name="Trailer">
			<Blob name="GIFTrailer" valueType="hex" value="3B" length="1" token="true"/>
		</Block>
	</DataModel>

  
  <!-- STATE MODEL SECTION -->
  <StateModel name="TheStateModel" initialState="Initial">
    <State name="Initial">

      <Action name="WriteFileFromSample" type="output" publisher="writer">
        <DataModel name="Gif" ref="GIF" />
        <Data name="data" fileName="SeedFile.gif" />
      </Action>

      <Action name="CloseFile"  type="close" publisher="writer" />
      <Action name="Launch" type="call" method="FuzzMe" publisher="Peach.Agent" />
    </State>
  </StateModel>


  <!-- ***************
       AGENT SECTION  
      *************** -->

  <Agent name="TheAgent">
    <Monitor class="WindowsDebugger">
      <Param name="CommandLine" value="C:\\windows\\system32\\mspaint.exe fuzzed.gif"/>
      <Param name="StartOnCall" value="FuzzMe"/>
      <Param name="CpuKill" value="true"/>
    </Monitor>

    <Monitor class="PageHeap">
      <Param name="Executable" value="mspaint.exe"/>
    </Monitor>
  </Agent>

  <!-- LINUX 
    <Agent name="TheAgent" location="http://127.0.0.1:9000">
      <Monitor class="debugger.UnixDebugger">
        <Param name="Command" value="/bin/target" />
        <Param name="Params" value="fuzzed.gif" />
        <Param name="StartOnCall" value="FuzzMe" />
      </Monitor>
    </Agent> 
    -->

  <!-- OSX
    <Agent name="TheAgent" location="http://127.0.0.1:9000">
      <Monitor class="osx.CrashWrangler">
        <Param name="Command" value="/Applications/Target/TargetName" />
        <Param name="Arguments" value="fuzzed.gif" />
        <Param name="ExecHandler" value="./exc_handler" />
        <Param name="StartOnCall" value="FuzzMe" />
      </Monitor>
    </Agent>
     -->


  <!-- **************
        TEST SECTION  
       ************** -->
  <Test name="Default">

    <Agent ref="TheAgent"/>
    <StateModel ref="TheStateModel" />

    <Publisher name="writer" class="file.FileWriter">
      <Param name="FileName" value="fuzzed.gif" />
    </Publisher>

    <!-- Command Line Launcher: Win/Lin/OSX  With Debugger -->
    <!--Publisher name="launch" class="process.DebuggerLauncher"/-->

    <!-- GUI Launcher: WINDOWS ONLY -->
    <!--
     <Publisher name="launch" class="process.DebuggerLauncherGui"> 
      <Param name="WindowName" value="GUI Window Name" /> 
     </Publisher> 
     -->
	 <Strategy class="Random" />
  <Logger class="logger.Filesystem">
      <Param name="Path" value="logs/GIF/"/>
    </Logger>
  </Test>

</Peach>
