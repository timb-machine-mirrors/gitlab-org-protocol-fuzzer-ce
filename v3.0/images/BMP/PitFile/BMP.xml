<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://phed.org/2012/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://peachfuzzer.com/2012/Peach peach.xsd"
	author="Deja vu Security" version="1">

  <!-- DATAMODEL SECTION -->
	<DataModel name="CIEXYZTRIPLE">
		<Block name="CIEXYZ1">
			<Block name="FXPT2DOT301">
				<Number name="Point" size="32" />
			</Block>
			<Block name="FXPT2DOT302">
				<Number name="Point" size="32" />
			</Block>
			<Block name="FXPT2DOT303">
				<Number name="Point" size="32" />
			</Block>
		</Block>
		<Block name="CIEXYZ2">
			<Block name="FXPT2DOT301">
				<Number name="Point" size="32" />
			</Block>
			<Block name="FXPT2DOT302">
				<Number name="Point" size="32" />
			</Block>
			<Block name="FXPT2DOT303">
				<Number name="Point" size="32" />
			</Block>
		</Block>
		<Block name="CIEXYZ3">
			<Block name="FXPT2DOT301">
				<Number name="Point" size="32" />
			</Block>
			<Block name="FXPT2DOT302">
				<Number name="Point" size="32" />
			</Block>
			<Block name="FXPT2DOT303">
				<Number name="Point" size="32" />
			</Block>
		</Block>
	</DataModel>

  <DataModel name="BMP" >
	<Block name="BMPHeader">
		<String name="Magic" length="2" value="BM">
			<Hint name="ValidValues" value="BM;BA;CI;CP;IC;PT" />
	  	</String>
      
  		<Number name="Size" size="32">
	  		<Relation type="size" of="BMP" />
  		</Number>
		
		<Blob name="Reserved" length="4" />
		
		<Number name="DataOffset" size="32">
			<Relation type="offset" of="TheBitmapData" />
		</Number>
  	</Block>

	<Block name="BitmapInfo">
		<Number name="Size" size="32">
			<Relation type="size" of="FormatChoice" expressionGet="size - 4" expressionSet="size + 4"/>
		</Number>
		<Choice name="FormatChoice">
			<Block name="BITMAPV5HEADER">
				<Number name="bV5Width" size="32"/>
				<Number name="bV5Height" size="32"/>
				<Number name="bV5Planes" size="16"/>
				<Number name="bV5BitCount" size="16"/>
				<Number name="bV5Compression" size="32"/>
				<Number name="bV5SizeImage" size="32"/>
				<Number name="bV5XPelsPerMeter" size="32"/>
				<Number name="bV5YPelsPerMeter" size="32"/>
				<Number name="bV5ClrUsed" size="32"/>
				<Number name="bV5ClrImportant" size="32"/>
				<Number name="bV5RedMask" size="32"/>
				<Number name="bV5GreenMask" size="32"/>
				<Number name="bV5BlueMask" size="32"/>
				<Number name="bV5AlphaMask" size="32"/>
				<Number name="bV5CSType" size="32"/>
				<Block name="bV5Endpoints" ref="CIEXYZTRIPLE"/>
				<Number name="bV5GammaRed" size="32"/>
				<Number name="bV5GammaGreen" size="32"/>
				<Number name="bV5GammaBlue" size="32"/>
				<Number name="bV5Intent" size="32"/>
				<Number name="bV5ProfileData" size="32"/>
				<Number name="bV5ProfileSize" size="32"/>
				<Number name="bV5Reserved" size="32"/>
			</Block>
			<Block name="BITMAPV4HEADER"> 
				<Number name="bV4Width" size="32"/>   
				<Number name="bV4Height" size="32"/>   
				<Number name="bV4Planes" size="16" /> 
				<Number name="bV4BitCount" size="16" />
				<Number name="bV4V4Compression" size="32"/>
				<Number name="bV4SizeImage" size="32"/>
				<Number name="bV4XPelsPerMeter" size="32"/>
				<Number name="bV4YPelsPerMeter" size="32"/>
				<Number name="bV4ClrUsed" size="32"/>
				<Number name="bV4ClrImportant" size="32"/>
				<Number name="bV4RedMask" size="32"/>
				<Number name="bV4GreenMask" size="32"/>
				<Number name="bV4BlueMask" size="32"/>
				<Number name="bV4AlphaMask" size="32"/>
				<Number name="bV4CSType" size="32"/>
				<Block name="bV4Endpoints" ref="CIEXYZTRIPLE" />
				<Number name="bV4GammaRed" size="32"/>
				<Number name="bV4GammaGreen" size="32"/>
				<Number name="bV4GammaBlue" size="32"/>
			</Block>
			<Block name="BITMAPINFOHEADER"> 
				<Number name="biWidth" size="32"/>
				<Number name="biHeight" size="32"/>
				<Number name="biPlanes" size="16" />
				<Number name="biBitCount" size="16" />
				<Number name="biCompression" size="32" />
				<Number name="biSizeImage" size="32" />
				<Number name="biXPelsPerMeter" size="32"/>
				<Number name="biYPelsPerMeter" size="32"/>
				<Number name="biClrUsed" size="32" />
				<Number name="biClrImportant" size="32" />
			</Block>
			<Block name="BITMAPCOREHEADER"> 
				<Number name="bcWidth" size="16"/>
				<Number name="bcHeight" size="16"/>
				<Number name="bcPlanes" size="16"/>
				<Number name="bcBitCount" size="16"/>
			</Block>
		</Choice>
  	</Block>
	<Blob name="TheColorPallete" />
	<Blob name="TheBitmapData" />
  </DataModel>


  <!-- STATE MODEL SECTION -->
  <StateModel name="TheStateModel" initialState="Initial">
    <State name="Initial">

      <Action name="WriteFileFromSample" type="output" publisher="writer">
        <DataModel ref="BMP" />
        <Data fileName="sample.bmp" />
      </Action>

      <Action name="CloseFile"  type="close" publisher="writer" />
      <Action name="Launch" type="call" method="FuzzMe" publisher="Peach.Agent" />
    </State>
  </StateModel>


  <!-- ***************
       AGENT SECTION  
      *************** -->

  <Agent name="TheAgent">
    <Monitor class="WindowsDebugger">
      <Param name="CommandLine" value="C:\\windows\\system32\\mspaint.exe fuzzed.bmp"/>
      <Param name="StartOnCall" value="FuzzMe"/>
      <Param name="CpuKill" value="true"/>
    </Monitor>

    <Monitor class="PageHeap">
      <Param name="Executable" value="mspaint.exe"/>
    </Monitor>
  </Agent>

  <!-- LINUX 
    <Agent name="TheAgent" location="http://127.0.0.1:9000">
      <Monitor class="debugger.UnixDebugger">
        <Param name="Command" value="/bin/target" />
        <Param name="Params" value="fuzzed.bmp" />
        <Param name="StartOnCall" value="FuzzMe" />
      </Monitor>
    </Agent> 
    -->

  <!-- OSX
    <Agent name="TheAgent" location="http://127.0.0.1:9000">
      <Monitor class="osx.CrashWrangler">
        <Param name="Command" value="/Applications/Target/TargetName" />
        <Param name="Arguments" value="fuzzed.bmp" />
        <Param name="ExecHandler" value="./exc_handler" />
        <Param name="StartOnCall" value="FuzzMe" />
      </Monitor>
    </Agent>
     -->


  <!-- **************
        TEST SECTION  
       ************** -->
  <Test name="Default">

    <Agent ref="TheAgent"/>
    <StateModel ref="TheStateModel" />

    <Publisher name="writer" class="file.FileWriter">
      <Param name="FileName" value="fuzzed.bmp" />
    </Publisher>

    <!-- Command Line Launcher: Win/Lin/OSX  With Debugger -->
    <!--Publisher name="launch" class="process.DebuggerLauncher"/-->
    
    <Logger class="logger.Filesystem">
      <Param name="Path" value="logs/BMP/"/>
    </Logger>
    
    <!-- GUI Launcher: WINDOWS ONLY -->
    <!--
     <Publisher name="launch" class="process.DebuggerLauncherGui"> 
      <Param name="WindowName" value="GUI Window Name" /> 
     </Publisher> 
     -->

  </Test>
</Peach>
