<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://peachfuzzer.com/2012/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://peachfuzzer.com/2012/Peach ../peach.xsd"
       author="Deja Vu Security, LLC" description="Internet Security Protocol v6 PIT" version="0.0.2">

  <!-- Copyright (c) Deja Vu Security, LLC 2012 -->
  <!-- Requires Linux Peach 3.0 and RawEther publisher -->
	<Include ns="IPv4" src="file:##Path##/IP/IPv4.xml"/>
	<Include ns="IPv6" src="file:##Path##/IP/IPv6.xml"/>
	<Include ns="TCP" src="file:##Path##/TCP/TCPv4.xml"/>
	<Include ns="UDP" src="file:##Path##/UDP/UDPv4.xml"/>
	
	
	<!--IPv6 Header used for Tunneling-->
	<DataModel name="IPv6Header">
		<Block name="Header">
			<Blob length="16"/>
					<Flags size="32" endian="big">
				<Flag name="Version" position="0" size="4" valueType="hex" value="6"/>
				<Flag name="DSCP" position="4" size="6" valueType="hex" value="00"/>
				<Flag name="ECN" position="10" size="2" valueType="hex" value="00"/>
				<Flag name="FlowLabel" position="12" size="20" valueType="hex" value="000000"/>
			</Flags>
			<Number name="PayloadLength" size="16" endian="big" valueType="hex">
				<Relation type="size" of="VlanPayload"/>
			</Number>
			<Number name="NextHeader" size="8" endian="big" value="50"/>
			<Number name="HopLimit" size="8" endian="big" valueType="hex" value="40"/> 
			<Blob name="SrcIP" value="##SourceIPv6##" >
				<Transformer class="Ipv6StringToOctet"/>
			</Blob>
			<Blob name="DestIP" value="##TargetIPv6##" >
				<Transformer class="Ipv6StringToOctet"/>
			</Blob>
			<Block name="VlanPayload">
				<Blob valueType="hex" value="08004d510001000a6162636465666768696a6b6c6d6e6f7071727374757677616263646566676869" mutable="false"/>
			</Block>
			<Padding name="Pad" aligned="true" alignment="128" >
				<Fixup class="FillValue">
					<Param name="ref" value="Pad"/>
					<Param name="start" value="1"/>
					<Param name="stop" value="15"/>
				</Fixup>
			</Padding>
			<Number name="PadLength" size="8" endian="big">
				<Relation type="size" of="Pad"/>
			</Number>
			<Blob name="NextHeader2" valueType="hex" length="1" value="11"/>
		</Block>
	</DataModel>

	<!--Data model for IPSECv6 w/ ESP Transport-->
	<DataModel name="IPSECv6Transport">
		<Block name="ESPHeader">
			<Blob name="SPI" valueType="hex" length="4" value="00 00 02 01" />
			<Number name="Sequence" size="32" value="1" endian="big"/>
				<Blob valueType="hex" name="IV" value="baae9ef59ff1ee56211769bd91da50ed"/>
				<Block name="EncryptedValues">
					<Block name="GetPaddingSize">
						<Block name="VlanPayload">
							<!--<Blob name="Payload" valueType="hex" value="08004d510001000a6162636465666768696a6b6c6d6e6f7071727374757677616263646566676869" mutable="false"/>-->
						</Block>
						<Padding name="Pad" aligned="true" alignment="128" >
							<Fixup class="FillValue">
								<Param name="ref" value="Pad"/>
								<Param name="start" value="1"/>
								<Param name="stop" value="15"/>
							</Fixup>
						</Padding>
						<Number name="PadLength" size="8" endian="big">
							<Relation type="size" of="Pad"/>
						</Number>
						<Blob name="NextHeader" valueType="hex" length="1" value="01"/>
					</Block>
					<Transformer class="Aes128">											
						<!-- <Param name="Key" value="000000000000000000000000000000000000000000000000"/> -->
						<Param name="Key" value="##CryptoKey##"/>
						<Param name="IV" value="baae9ef59ff1ee56211769bd91da50ed"/> <!--AES128 IV -->
						<!--<Param name="IV" value="aeaeaeaeaeaeaeae"/>--> <!--3Des IV -->
					</Transformer>
				</Block>
		</Block>
		<Blob name="ICV" valueType="hex">
		<!--UnComment for SHA or change to 			<Fixup class="SHA256Fixup">
			<Fixup class="SHA1Fixup">
				<Param name="ref" value="ESPHeader"/>
			</Fixup>
		-->
		</Blob>
	</DataModel>

	<DataModel name="IPv6EmptyPacketIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block  name="PayloadIPv6Header" ref="IPv6:IPv6Header"/>
				<Block name="IPv6Header" ref="IPv6:IPv6Header">
					<Number name="Header.NextHeader" size="8" endian="big" value="59"/>
					<Number name="Header.PayloadLength" value="0" size="16"/>
				</Block>
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="59"/>
		</Block>
	</DataModel>

	<DataModel name="IPv6ICMPIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="58"/>
				</Block>
				<Block name="Payload">
		  		<Number name="Type" size="8"  value="128" endian="network"/>
          <Number name="Code" size="8"/>
          <Number name="Checksum"  endian="big" size="16">
            <Fixup class="IcmpV6ChecksumFixup">
              <Param name="ref" value="Payload" />
              <Param name="src" value="##SourceIPv6##" />
              <Param name="dst" value="##TargetIPv6##" />
            </Fixup>
          </Number>
          <Number name="Identifier" endian="big" size="16" valueType="hex" value="00 01" />
          <Number name="Sequence" endian="big" size="16" valueType="hex" value="00 01" />
          <Blob name="Data" valueType="hex" value="6162636465666768696a6b6c6d6e6f7071727374757677616263646566676869"/>
				</Block>
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="58"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6HopByHopIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="0"/>
				</Block>
				<Block name="Payload" ref="IPv6:HopByHop"/>
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="0"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6JumbogramIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="0"/>
				</Block>
				<Block name="Payload" ref="IPv6:JumboFrame"/>
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="0"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6Fragment1IPSECv6Transport">
		<!-- This may be brken -->
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="44"/>
				</Block>
				<Block name="Payload">
					<Block ref="IPv6:Fragment">
						<Flags name="Flags" size="16" endian="big">
							<Flag name="Offset" size="13" position="0" value="0"/>
							<Flag name="Res" size="2" position="13"/>
							<Flag name="Mflag" size="1" position="15" value="1"/>
						</Flags>
						<Number name="Identification" size="32" endian="big" value="374625"/>
					</Block>
					<Blob name="Data" length="12"/>
				</Block>
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="44"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6Fragment2IPSECv6Transport">
		<!-- This may be brken -->
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="44"/>
				</Block>
				<Block name="Payload">
					<Block ref="IPv6:Fragment">
						<Flags name="Flags" size="16" endian="big">
							<Flag name="Offset" size="13" position="0" value="12"/>
							<Flag name="Res" size="2" position="13"/>
							<Flag name="Mflag" size="1" position="15" value="1"/>
						</Flags>
						<Number name="Identification" size="32" endian="big" value="374625"/>
					</Block>
					<Blob name="Data" length="12"/>
				</Block>	
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="44"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6Fragment3IPSECv6Transport">
		<!-- This may be brken -->
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="44"/>
				</Block>
				<Block name="Payload">
					<Block ref="IPv6:Fragment">
						<Flags name="Flags" size="16" endian="big">
							<Flag name="Offset" size="13" position="0" value="24"/>
							<Flag name="Res" size="2" position="13"/>
							<Flag name="Mflag" size="1" position="15" value="0"/>
						</Flags>
						<Number name="Identification" size="32" endian="big" value="374625"/>
					</Block>
					<Blob name="Data" length="12"/>
				</Block>		
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="44"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6DestinationOptionsIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="59"/>
				</Block>
				<Block name="Payload">
					<Block ref="IPv6:DestinationOptions">
						<Block name="Options">
							<Block ref="IPv6:TLV" name="HomeAddressOption">
								<Number name="Type" size="8" endian="big" value="201"/>
								<Block name="Value">
									<Blob length="16" valueType="hex"/>
								</Block>
							</Block>
						</Block>
					</Block>
					<Padding aligned="true" alignment="64"/>
				</Block>
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="59"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6MobileBRRIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="135"/>
				</Block>
				<Block name="Payload">
					<Block ref="IPv6:Mobile">
						<Number name="HeaderLen" size="8" endian="big">
							<Relation type="size" of="Payload" expressionGet="size" expressionSet="(((size-8) > 0) and ((size-8)/8)) or 0"/>
						</Number>
						<Number name="MH" size="8" endian="big" value="0"/>
						<Number name="Checksum" size="16" endian="big">
							<Fixup class="IcmpV6ChecksumFixup">
								<Param name="ref" value="IPv6MobileBRRIPSECv6Transport"/>
								<Param name="src" value="##SourceIPv6##"/>
								<Param name="dst" value="##TargetIPv6##"/>
							</Fixup>
						</Number>
					</Block>
					<Number name="Reserved" size="16"/>
					<Block name="MobilityOptions"/>
					<Padding aligned="true" alignment="64"/>
				</Block>	
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="135"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6MobileHoTIIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="135"/>
				</Block>
				<Block name="Payload">
					<Block ref="IPv6:Mobile">
						<Number name="HeaderLen" size="8" endian="big">
							<Relation type="size" of="MobilityOptions" expressionGet="size" expressionSet="(((size-8) > 0) and ((size-8)/8)) or 1"/>
						</Number>
						<Number name="MH" size="8" endian="big" value="1"/>
						<Number name="Checksum" size="16" endian="big">
							<Fixup class="IcmpV6ChecksumFixup">
								<Param name="ref" value="IPv6MobileHoTIIPSECv6Transport"/>
								<Param name="src" value="##SourceIPv6##"/>
								<Param name="dst" value="##TargetIPv6##"/>
							</Fixup>
						</Number>
					</Block>
					<Number name="Reserved" size="16"/>
					<Number name="HomeInitCookie" size="64"/>
					<Block name="MobilityOptions">
					</Block>
					<Padding aligned="true" alignment="64"/>
				</Block>	
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="135"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6MobileCoTIIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="135"/>
				</Block>
				<Block name="Payload">
					<Block ref="IPv6:Mobile">
						<Number name="HeaderLen" size="8" endian="big">
							<Relation type="size" of="Payload" expressionGet="size" expressionSet="(((size-8) > 0) and ((size-8)/8)) or 1"/>
						</Number>
						<Number name="MH" size="8" endian="big" value="2"/>
						<Number name="Checksum" size="16" endian="big">
							<Fixup class="IcmpV6ChecksumFixup">
								<Param name="ref" value="IPv6MobileCoTIIPSECv6Transport"/>
								<Param name="src" value="##SourceIPv6##"/>
								<Param name="dst" value="##TargetIPv6##"/>
							</Fixup>
						</Number>
					</Block>
					<Number name="Reserved" size="16"/>
					<Number name="CareInitCookie" size="64"/>
					<Block name="MobilityOptions"/>
					<Padding aligned="true" alignment="64"/>
				</Block>	
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="135"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6MobileHoTIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="135"/>
				</Block>
				<Block name="Payload">
					<Block ref="IPv6:Mobile">
						<Number name="HeaderLen" size="8" endian="big">
							<Relation type="size" of="Payload" expressionGet="size" expressionSet="(((size-8) > 0) and ((size-8)/8)) or 2"/>
						</Number>
						<Number name="MH" size="8" endian="big" value="3"/>
						<Number name="Checksum" size="16" endian="big">
							<Fixup class="IcmpV6ChecksumFixup">
								<Param name="ref" value="IPv6MobileHoTIPSECv6Transport"/>
								<Param name="src" value="##SourceIPv6##"/>
								<Param name="dst" value="##TargetIPv6##"/>
							</Fixup>
						</Number>
					</Block>
					<Number name="HomeNonceIndex" size="16"/>
					<Number name="HomeInitCookie" size="64"/>
					<Number name="HomeKeygenToken" size="64"/>
					<Block name="MobilityOptions"/>
					<Padding aligned="true" alignment="64"/>
				</Block>	
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="135"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6MobileCoTIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="135"/>
				</Block>
				<Block name="Payload">
					<Block ref="IPv6:Mobile">
						<Number name="HeaderLen" size="8" endian="big">
							<Relation type="size" of="Payload" expressionGet="size" expressionSet="(((size-8) > 0) and ((size-8)/8)) or 2"/>
						</Number>
						<Number name="MH" size="8" endian="big" value="4"/>
						<Number name="Checksum" size="16" endian="big">
							<Fixup class="IcmpV6ChecksumFixup">
								<Param name="ref" value="IPv6MobileCoTIPSECv6Transport"/>
								<Param name="src" value="##SourceIPv6##"/>
								<Param name="dst" value="##TargetIPv6##"/>
							</Fixup>
						</Number>
					</Block>
					<Number name="CareNonceIndex" size="16"/>
					<Number name="CareInitCookie" size="64"/>
					<Number name="CareKeygenToken" size="64"/>
					<Block name="MobilityOptions"/>
					<Padding aligned="true" alignment="64"/>
				</Block>	
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="135"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6MobileBUIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="135"/>
				</Block>
				<Block name="Payload">
					<Block ref="IPv6:Mobile">
						<Number name="HeaderLen" size="8" endian="big">
							<Relation type="size" of="Payload" expressionGet="size" expressionSet="(((size-8) > 0) and ((size-8)/8)) or 1"/>
						</Number>
						<Number name="MH" size="8" endian="big" value="5"/>
						<Number name="Checksum" size="16" endian="big">
							<Fixup class="IcmpV6ChecksumFixup">
								<Param name="ref" value="IPv6MobileBUIPSECv6Transport"/>
								<Param name="src" value="##SourceIPv6##"/>
								<Param name="dst" value="##TargetIPv6##"/>
							</Fixup>
						</Number>
					</Block>
					<Number name="Sequence" size="16" signed="false"/>
					<Flags size="16" endian="big">
						<Flag name="A" size="1" position="0"/>
						<Flag name="H" size="1" position="1"/>
						<Flag name="L" size="1" position="2"/>
						<Flag name="K" size="1" position="3"/>
						<Flag name="Reserved" size="12" position="4"/>
					</Flags>
					<Number name="Lifetime" size="16" signed="false"/>
					<Block name="MobilityOptions">
						<Block name="NonceIndices" ref="IPv6:TLV">
							<Number name="Type" size="8" endian="big" value="4"/>
							<Block name="Value">
								<Number name="HomeNonceIndex" size="16"/>
								<Number name="CareNonceIndex" size="16"/>
							</Block>
						</Block>
						<Block name="AltCareofAddress" ref="IPv6:TLV">
							<Number name="Type" size="8" endian="big" value="3"/>
							<Block name="Value">
								<Blob name="AltCareAddress" length="16"/>
							</Block>
						</Block>
						<Block name="BindingAuthData" ref="IPv6:TLV">
							<Number name="Type" size="8" endian="big" value="5"/>
							<Block name="Value">
								<Blob name="Authenticator" length="12" valueType="hex"/>
							</Block>
						</Block>
					</Block>
					<Padding aligned="true" alignment="64"/>
				</Block>	
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="135"/>
		</Block>
	</DataModel>

	<DataModel name="IPv6MobileBAIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="135"/>
				</Block>
				<Block name="Payload">
					<Block ref="IPv6:Mobile">
						<Number name="HeaderLen" size="8" endian="big">
							<Relation type="size" of="Payload" expressionGet="size" expressionSet="(((size-8) > 0) and ((size-8)/8)) or 1"/>
						</Number>
						<Number name="MH" size="8" endian="big" value="6"/>
						<Number name="Checksum" size="16" endian="big">
							<Fixup class="IcmpV6ChecksumFixup">
								<Param name="ref" value="IPv6MobileBAIPSECv6Transport"/>
								<Param name="src" value="##SourceIPv6##"/>
								<Param name="dst" value="##TargetIPv6##"/>
							</Fixup>
						</Number>
					</Block>
					<Number name="Status" size="8" signed="false"/>
					<Flags size="8" endian="big">
						<Flag name="K" size="1" position="0"/>
						<Flag name="Reserved" size="7" position="1"/>
					</Flags>
					<Number name="Sequnce" size="16" signed="false"/>
					<Number name="Lifetime" size="16" signed="false"/>
					<Block name="MobilityOptions">
						<Block name="BindingRefreshAdvice" ref="IPv6:TLV">
							<Number name="Type" size="8" endian="big" value="2"/>
							<Number name="Length" size="8" endian="big" value="2"/>
							<Block name="Value">
								<Number name="RefreshInterval" size="16" endian="big"/> 
							</Block>
						</Block>
						<Block name="BindingAuthData" ref="IPv6:TLV">
							<Number name="Type" size="8" endian="big" value="5"/>
							<Number name="Length" size="8" endian="big">
								<Relation type="size" of="Value"/>
							</Number>
							<Block name="Value">
								<Blob name="Authenticator" length="12" valueType="hex"/>
							</Block>
						</Block>
					</Block>
					<Padding aligned="true" alignment="64"/>
				</Block>	
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="135"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6MobileBEIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="135"/>
				</Block>
				<Block name="Payload">
					<Block ref="IPv6:Mobile">
						<Number name="HeaderLen" size="8" endian="big">
							<Relation type="size" of="Payload" expressionGet="size" expressionSet="(((size-8) > 0) and ((size-8)/8)) or 2"/>
						</Number>
						<Number name="MH" size="8" endian="big" value="7"/>
						<Number name="Checksum" size="16" endian="big">
							<Fixup class="IcmpV6ChecksumFixup">
								<Param name="ref" value="IPv6MobileBEIPSECv6Transport"/>
								<Param name="src" value="##SourceIPv6##"/>
								<Param name="dst" value="##TargetIPv6##"/>
							</Fixup>
						</Number>
					</Block>
					<Number name="Status" size="8" signed="false"/>
					<Number name="Reserved" size="8"/>
					<Blob name="HomeAddress" length="16"/>
					<Block name="MobilityOptions"/>
					<Padding aligned="true" alignment="64"/>
				</Block>	
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="135"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6RoutingType2HeaderIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="43"/>
				</Block>
				<Block name="Payload">
					<Block ref="IPv6:MobileRoutingType2Header">
						<Number name="NextHeader" size="8" endian="big" value="59"/>
					</Block>	
				</Block>
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="43"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6ICMPHomeAgentAddressDiscoveryRequestIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="58"/>
				</Block>
				<Block name="Payload">
					<Block ref="IPv6:MobileICMP">
						<Number name="Type" size="8" endian="big" value="144"/>
						<Number name="Code" size="8" endian="big" value="0"/>
						<Number name="Checksum" size="16" endian="big">
							<Fixup class="IcmpV6ChecksumFixup">
								<Param name="ref" value="Payload"/>
								<Param name="src" value="##SourceIPv6##"/>
								<Param name="dst" value="##TargetIPv6##"/>
							</Fixup>
						</Number>
						<Block name="Reserved">
							<Number size="16" endian="big"/>
						</Block>	
					</Block>
				</Block>
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="58"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6ICMPHomeAgentAddressDiscoveryReplyIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="58"/>
				</Block>
				<Block name="Payload">
					<Block ref="IPv6:MobileICMP">
						<Number name="Type" size="8" endian="big" value="145"/>
						<Number name="Code" size="8" endian="big" value="0"/>
						<Number name="Checksum" size="16" endian="big">
							<Fixup class="IcmpV6ChecksumFixup">
								<Param name="ref" value="Payload"/>
								<Param name="src" value="##SourceIPv6##"/>
								<Param name="dst" value="##TargetIPv6##"/>
							</Fixup>
						</Number>
						<Block name="Reserved">
							<Number size="16" endian="big"/>
						</Block>
					</Block>
					<Block name="HomeAgentAddresses">
						<Blob name="Address1" length="16" valueType="hex"/>
						<Blob name="Address2" length="16" valueType="hex"/>
					</Block>
				</Block>
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="58"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6ICMPPrefixSolicitationIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="58"/>
				</Block>
				<Block name="Payload">
					<Block ref="IPv6:MobileICMP">
						<Number name="Type" size="8" endian="big" value="146"/>
						<Number name="Code" size="8" endian="big" value="0"/>
						<Number name="Checksum" size="16" endian="big">
							<Fixup class="IcmpV6ChecksumFixup">
								<Param name="ref" value="Payload"/>
								<Param name="src" value="##SourceIPv6##"/>
								<Param name="dst" value="##TargetIPv6##"/>
							</Fixup>
						</Number>
						<Block name="Reserved">
							<Number size="16" endian="big"/>
						</Block>
					</Block>
				</Block>
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="135"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6ICMPPrefixAdvertisementIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="58"/>
				</Block>
				<Block name="Payload">
					<Block ref="IPv6:MobileICMP">
						<Number name="Type" size="8" endian="big" value="147"/>
						<Number name="Code" size="8" endian="big" value="0"/>
						<Number name="Checksum" size="16" endian="big">
							<Fixup class="IcmpV6ChecksumFixup">
								<Param name="ref" value="Payload"/>
								<Param name="src" value="##SourceIPv6##"/>
								<Param name="dst" value="##TargetIPv6##"/>
							</Fixup>
						</Number>
						<Block name="Reserved">
							<Flags size="16">
								<Flag name="M" size="1" position="0"/>
								<Flag name="O" size="1" position="1"/>
								<Flag name="Reserved" size="14" position="2"/>
							</Flags>
						</Block>
						<Block name="Options">
						</Block>
					</Block>
				</Block>
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="58"/>
		</Block>
	</DataModel>	
	
	
	<DataModel name="IPv6ICMPRouterAdvertismentIPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="58"/>
				</Block>
				<Block name="Payload">
					<Block ref="IPv6:MobileICMPRouterAdvertisement">
						<Number name="Type" size="8" endian="big" value="134"/>
						<Number name="Code" size="8" endian="big" value="0"/>
						<Number name="Checksum" size="16" endian="big">
							<Fixup class="IcmpV6ChecksumFixup">
								<Param name="ref" value="Payload"/>
								<Param name="src" value="##SourceIPv6##"/>
								<Param name="dst" value="##TargetIPv6##"/>
							</Fixup>
						</Number>
						<Flags name="Flags" size="8">
							<Flag name="M" size="1" position="0"/>
							<Flag name="O" size="1" position="1"/>
							<Flag name="H" size="1" position="2"/>
							<Flag name="Reserved" size="5" position="3"/>
						</Flags>
						<Block name="Options">
							<Block name="PrefixInformation">
								<Number name="Type" size="8" endian="big" value="3"/>
								<Number name="Length" size="8" endian="big" value="4"/>
								<Number name="PrefixLength" size="8" endian="big"/>
								<Flags size="8" endian="big">
									<Flag name="L" size="1" position="0"/>
									<Flag name="A" size="1" position="1"/>
									<Flag name="R" size="1" position="2"/>
									<Flag name="Reserved" size="5" position="3"/>
								</Flags>
								<Number name="ValidLifeTime" size="32" endian="big" signed="false"/>
								<Number name="PreferredLifetime" size="32" endian="big" signed="false"/>
								<Number name="Reserved2" size="32" endian="big"/>
								<Blob name="Prefix" length="16" valueType="hex"/>
							</Block>
							<Block name="AdvertisementInterval">
								<Number name="Type" size="8" endian="big" value="7"/>
								<Number name="Length" size="8" endian="big" value="1"/>
								<Number name="Reserved" size="16" endian="big"/>
								<Number name="AdvertisementInterval" size="32" endian="big"/>
							</Block>
						</Block>
					</Block>
				</Block>
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="58"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv4TCPv4IPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block name="PayloadContent" ref="IPv4:IPv4">
					<Number name="Header.Protocol" size="8" endian="big" valueType="hex" value="06"/>
					<Block name="Payload">
						<Block name="TCP" ref="TCP:TCP">
							<Number name="TCPHeader.CheckSum" size="16" endian="big">
								<Fixup class="TCPChecksumFixup">
									<Param name="ref" value="TCP" />
									<Param name="src" value="##SourceIPv4##" />
									<Param name="dst" value="##TargetIPv4##" />
								</Fixup>
							</Number>
							<Block name="TCPData">
								<Blob value="Hello"/>
							</Block>
						</Block>
					</Block>
				</Block>
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="06"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv4IPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block name="PayloadContent">
				  <Block name="IPv4" ref="IPv4:IPv4">
						<Block name="Payload">
							<Blob valueType="hex" value="0800b95d0bec0001c686c14ebedc010008090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f3031323334353637"/>
						</Block>
					</Block>
				</Block>
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="01"/>
		</Block>
	</DataModel>
	
	
	<DataModel name="IPv6TCPv6IPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block name="PayloadContent" ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="06"/>
				</Block>
				<Block name="Payload">
					<Block name="TCP" ref="TCP:TCP">
						<Number name="TCPHeader.CheckSum" size="16" endian="big">
							<Fixup class="TCPChecksumFixup">
								<Param name="ref" value="TCP" />
								<Param name="src" value="##SourceIPv6##" />
								<Param name="dst" value="##TargetIPv6##" />
							</Fixup>
						</Number>
						<Block name="TCPData">
							<Blob value="Hello"/>
						</Block>
					</Block>
				</Block>
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="06"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv4UDPv4IPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block name="PayloadContent" ref="IPv4:IPv4">
					<Number name="Header.Protocol" size="8" endian="big" valueType="hex" value="11"/>
					<Block name="Payload">
						<Block name="UDPHeader" ref="UDP:UDPHeader">
							<Number name="Checksum" size="16" endian="big">
								<Fixup class="UDPChecksumFixup">
									<Param name="ref" value="UDPHeader" />
									<Param name="src" value="##SourceIPv4##" />
									<Param name="dst" value="##TargetIPv4##" />
								</Fixup>
							</Number>
							<Block name="UDPData">
								<Blob value="Hello"/>
							</Block>
						</Block>
					</Block>
				</Block>
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="17"/>
		</Block>
	</DataModel>
	
	<DataModel name="IPv6UDPv6IPSECv6Transport">
		<Block ref="IPSECv6Transport">
			<Block name="ESPHeader.EncryptedValues.GetPaddingSize.VlanPayload">
				<Block name="PayloadContent" ref="IPv6:IPv6Header">
					<Number name="Header.PayloadLength" size="16" endian="big">
						<Relation type="size" of="Payload" />
					</Number>
					<Number name="Header.NextHeader" size="8" endian="big" value="17"/>
				</Block>
				<Block name="Payload">
					<Block name="UDPHeader" ref="UDP:UDPHeader">
						<Number name="Checksum" size="16" endian="big">
							<Fixup class="UDPChecksumFixup"> 
								<Param name="ref" value="UDPHeader" />
								<Param name="src" value="##SourceIPv6##" />
								<Param name="dst" value="##TargetIPv6##" />
							</Fixup>
						</Number>
						<Block name="UDPData">
							<Blob value="Hello"/>
						</Block>
					</Block>
				</Block>
			</Block>
			<Blob name="ESPHeader.EncryptedValues.GetPaddingSize.NextHeader" value="17"/>
		</Block>
	</DataModel>
	
	<!--Data model for IPSECv6 w/ ESP Tunnel-->
	<DataModel name="IPSECv6Tunnel">
		<Block name="ESPHeader">
			<Blob name="SPI" valueType="hex" length="4" value="ad3436b6" />
			<Number name="Sequence" size="32" value="1" endian="network"/>
			<Blob valueType="hex" name="IV" value="aeaeaeaeaeaeaeaeaeaeaeaeaeaeaeae"/>
				<Block ref="IPv6Header">
					<Transformer class="Aes128">
						<!-- <Param name="Key" value="7465737470617373776f7264646f6e65"/> -->
						<Param name="Key" value="##CryptoKey##"/>
						<Param name="IV" value="aeaeaeaeaeaeaeaeaeaeaeaeaeaeaeae"/> <!--AES128 IV -->
						<!--<Param name="IV" value="aeaeaeaeaeaeaeae"/>--> <!--3Des IV -->
					</Transformer>
				</Block>
		</Block>
		<Blob name="ICV" valueType="hex">
			<!--UnComment for SHA or change to 			<Fixup class="SHA256Fixup">
			<Fixup class="SHA1Fixup">
				<Param name="ref" value="ESPHeader"/>
			</Fixup>-->
		</Blob>
	</DataModel>
	
	<Agent name="RemoteAgent" location="tcp://##RemoteAgentIP##:9001">
		<Monitor class="Process">
			<Param name="Executable" value="##tsharkBin##" />
			<Param name="Arguments" value="-i ##tsharkInterface##" />
			<Param name="FaultOnEarlyExit" value="true" />
		</Monitor>
		<Monitor class="Pcap">
			<Param name="Device" value="##Interface##" />
		</Monitor>
	</Agent>

  <Agent name="LocalAgent">
    <Monitor class="Pcap">
      <Param name="Device" value="##Interface##" />
    </Monitor>
  </Agent>
  
  <StateModel name="TheState" initialState="Initial">
    <State name="Initial">
      <Action type="output">
				<DataModel ref="IPv6EmptyPacketIPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6ICMPIPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6HopByHopIPSECv6##Mode##"/>
      </Action>
			<!--<Action type="output">
				<DataModel ref="IPv6JumbogramIPSECv6##Mode##"/>
      </Action>-->
			<Action type="output">
				<DataModel ref="IPv6Fragment1IPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6Fragment2IPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6Fragment3IPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6DestinationOptionsIPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6MobileBRRIPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6MobileHoTIIPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6MobileCoTIIPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6MobileHoTIPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6MobileCoTIPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6MobileBUIPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6MobileBAIPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6MobileBEIPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6RoutingType2HeaderIPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6ICMPHomeAgentAddressDiscoveryRequestIPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6ICMPHomeAgentAddressDiscoveryReplyIPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6ICMPPrefixSolicitationIPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6ICMPPrefixAdvertisementIPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6ICMPRouterAdvertismentIPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv4TCPv4IPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv4IPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6TCPv6IPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv4UDPv4IPSECv6##Mode##"/>
      </Action>
			<Action type="output">
				<DataModel ref="IPv6UDPv6IPSECv6##Mode##"/>
      </Action>
    </State>
  </StateModel>
  
  <!-- Default test for fuzzing IPSECv6 ESP-->
  <Test name="Default">
    <!--<Agent ref="RemoteAgent"/>-->
    <StateModel ref="TheState"/>
    <Publisher class="RawV6">
      <Param name="Host" value="##TargetIPv6##"/>
      <Param name="Interface" value="##SourceIPv6##"/>
      <Param name="Protocol" value="50"/>
    </Publisher>
    
    <Strategy class="##Strategy##"/>
    <Logger class="logger.Filesystem" >
      <Param name="Path" value="##LoggerPath##" />
    </Logger>
  </Test>
</Peach>
