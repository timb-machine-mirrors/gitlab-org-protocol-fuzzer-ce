<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://peachfuzzer.com/2012/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://peachfuzzer.com/2012/Peach /peach/peach.xsd"
       author="Deja Vu Security, LLC" description="Link Layer Discovery Protocol PIT" version="0.0.2">
  <!-- Copyright (c) Deja Vu Security, LLC 2012 -->

  <!-- Requires Linux Peach 3 and RawEther publisher -->

  <!-- Link Layer Discovery Protocol Main DataModel -->
  <DataModel name="LLDP">
    <Block name="EtherHeader" mutable="false">
      <Blob name="Dest" valueType="hex" value="0180c200000e" mutable="false"/> <!-- LLDP multicast address --> 
      <Blob name="Src" valueType="hex" value="##SourceMAC##" mutable="false"/>
      <Blob name="Type" valueType="hex" value="88cc" mutable="false"/>
    </Block>

    <Block name="LLDPPayload" minOccurs="1">
      <Block name="ChasisTlv">
				<Block name="ChasisTlvHeader">
					<Number name="ChasisTlvType" size="7" endian="big" value="1"/>
					<Number name="ChasisTlvSize" size="9" endian="big" value="7">
						<Relation type="size" of="ChasisId"/>
					</Number>
				</Block>
				<Block name="ChasisId">
					<Number name="ChasisIdSubtype" size="8" value="04" valueType="hex" endian="big"/>
					<Blob name="ChasisIdValue" value="##SourceMAC##" valueType="hex"/>
				</Block>
      </Block>


      <Block name="PortTlv" minOccurs="1">
				<Block name="PortTlvHeader">
					<Number name="PortTlvType" size="7" endian="big" value="2"/>
					<Number name="PortTlvSize" size="9" endian="big" value="7">
						<Relation type="size" of="PortId"/>
					</Number>
				</Block>
				<Block name="PortId">
					<Number name="PortIdSubtype" size="8" value="03" valueType="hex"	endian="big"/>
					<Blob name="PortIdValue" value="##SourceMAC##" valueType="hex"/>
				</Block>
      </Block>


      <Block name="TtlTlv" minOccurs="1">
				<Block name="TtlTlvHeader">
					<Number name="TtlTlvType" size="7" endian="big" value="3"/>
					<Number name="TtlTlvSize" size="9" endian="big" value="2">
						<Relation type="size" of="TtlValue"/>
					</Number>
				</Block>
				<Number name="TtlValue" size="16" value="120" endian="big"/>
      </Block>


      <Block name="PortDescripTlv">
				<Block name="PortDescripTlvHeader">
					<Number name="PortDescripTlvType" size="7" endian="big" value="4"/>
					<Number name="PortDescripTlvSize" size="9" endian="big" value="10">
						<Relation type="size" of="PortDescripValue"/>
					</Number>
				</Block>
				<Blob name="PortDescripValue" value="Summit300-48-Port 1001" />
      </Block>


      <Block name="SystemNameTlv">
				<Block name="SystemNameTlvHeader">
					<Number name="SystemNameTlvType" size="7" endian="big" value="5"/>
					<Number name="SystemNameTlvSize" size="9" endian="big" value="6">
						<Relation type="size" of="SystemNameValue"/>
					</Number>
				</Block>
				<Blob name="SystemNameValue" value="##Hostname##"/>
      </Block>

      <Block name="SystemDescripTlv">
				<Block name="SystemDescripTlvHeader">
					<Number name="SystemDescripTlvType" size="7" endian="big" value="6"/>
					<Number name="SystemDescripTlvSize" size="9" endian="big" value="6">
						<Relation type="size" of="SystemDescripValue"/>
					</Number>
				</Block>
				<Blob name="SystemDescripValue" value="Summit300-48 - Version 7.4e.1 (Build 5) by Release_Master 05/27/05 04:53:11"/>
      </Block>

      <Block name="CapabilitesTlv">
				<Block name="CapabilitesTlvHeader">
					<Number name="CapabilitesTlvType" size="7" endian="big" value="7"/>
					<Number name="CapabilitesTlvSize" size="9" endian="big" value="4">
						<Relation type="size" of="CapabilitiesValue"/>
					</Number>
				</Block>
				<Block name="CapabilitiesValue">
					<Blob name="CapabilitiesAvalible" value="ffff" valueType="hex"/>
					<Blob name="CapabilitiesEnabled" value="ffff" valueType="hex"/>
				</Block>
      </Block>

      <Block name="ManagementAddressTlv">
				<Block name="ManagementAddressTlvHeader">
					<Number name="ManagementAddressTlvType" size="7" endian="big" value="5"/>
					<Number name="ManagementAddressTlvSize" size="9" endian="big" value="6">
						<Relation type="size" of="ManagementAddressValue"/>
					</Number>
				</Block>
				<Block name="ManagementAddress">
					<Number name="ManagementAddressSubtype" size="8" value="06" valueType="hex" endian="big"/>
					<Blob name="ManagementAddressValue" value="##SourceMAC##" valueType="hex"/>
					<Number name="InterfaceSubtype" size="8" value="02" valueType="hex" endian="big"/>
					<Number name="InterfaceNumber" size="16" value="1001" />
					<Number name="OIDLength" size="8" value="00" />
				</Block>
      </Block>

      <Block name="OrganizationSpecificTlv">
				<Block name="OrganizationSpecificTlvHeader">
					<Number name="OrganizationSpecificTlvType" size="7" endian="big" value="127"/>
					<Number name="OrganizationSpecificTlvSize" size="9" endian="big" value="6">
						<Relation type="size" of="OrganizationSpecificValue"/>
					</Number>
				</Block>
				<Block name="OrganizationSpecificValue">
					<Blob name="OrganizationUniqueCode" value="0000" valueType="hex" />
					<!-- this is the beginning of LLDP-MED, and it could have it's pit -->
				</Block>
      </Block>


      <Blob name="EndOfLLDPDU" value="00 00" valueType="hex" minOccurs="1" />
    </Block>

  </DataModel>

  <!-- LLDP Simple State Model -->
  <StateModel name="TheStateModel" initialState="Initial">
    <State name="Initial">
      <Action name="LldpSendPacket" type="output" publisher="RawHandler">
        <!--Action name="ViewPacket" type="output" publisher="HexHandler"-->
				<DataModel ref="LLDP" />
      </Action>
    </State>
  </StateModel>

  <Agent name="RemoteAgent" location="tcp://##RemoteAgentIP##:9001">
    <Monitor class="Process">
      <Param name="Executable" value="##tsharkBin##" />
      <Param name="Arguments" value="-i ##tsharkInterface##" />
      <Param name="FaultOnEarlyExit" value="true" />
    </Monitor>
    <Monitor class="Pcap">
      <Param name="Device" value="##Interface##" />
    </Monitor>
  </Agent>

  <Agent name="LocalAgent">
    <Monitor class="Pcap">
      <Param name="Device" value="##Interface##" />
    </Monitor>
  </Agent>

  <!-- Default test for LLDP -->
  <Test name="Default">
    <Strategy class="Sequential"/>
    <StateModel ref="TheStateModel"/>
    <Agent ref="RemoteAgent"/>
    <Agent ref="LocalAgent"/>
    <Publisher class="RawEther" name="RawHandler">
      <Param name="Interface" value="##Interface##"/>
      <Param name="Protocol" value="ETH_P_IP"/>
    </Publisher>
    
    <Strategy class="##Strategy##"/>
    <Logger class="logger.Filesystem" >
      <Param name="Path" value="##LoggerPath##" />
    </Logger>
  </Test>
</Peach>
