<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://peachfuzzer.com/2012/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
			 xsi:schemaLocation="http://peachfuzzer.com/2012/Peach ../peach.xsd"
       author="Deja Vu Security, LLC" description="Telnet Command Protocol PIT" version="0.0.2">

  <!-- Copyright (c) Deja Vu Security, LLC 2013 -->
	
	<Include ns="FTP" src="file:##Path##/networking/FTP/ftp.xml"/>

	<!-- FTP simple state model -->
	<StateModel name="AgentToHost" initialState="InputUserName">
		<State name="InputUserName">
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="FTP:ServerReadyForUser" />
			</Action>
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="FTP:USER" />
			</Action>
			<Action type="changeState" ref="InputPasswd"/>
		</State>

		<State name="InputPasswd">
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="FTP:ServerUserNeedsPass" />
			</Action>
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="FTP:PASS" />
			</Action>
			<Action type="changeState" ref="TestConnection"/>
		</State>

		<State name="TestConnection">
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="FTP:ServerLoggedIn" />
			</Action>
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="FTP:NOOP" />
			</Action>
			<Action type="changeState" ref="MakeDir"/>
		</State>

		<State name="MakeDir">
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="FTP:ServerOk" />
			</Action>
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="FTP:MKD" />
			</Action>
			<Action type="changeState" ref="DelDir"/>
		</State>

		<State name="DelDir">
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="FTP:DirCreated" />
			</Action>
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="FTP:RMD" />
			</Action>
			<Action type="changeState" ref="Ready"/>
		</State>

		<State name="Ready">
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="FTP:ResponseTemplate" />
				<!-- <DataModel ref="Response" /> -->
			</Action>
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="FTP:Request" />
			</Action>
		</State>

	</StateModel>

	<Agent name="WinRemoteAgent" location="tcp://##RemoteAgentIP##:9001">
		<Monitor class="WindowsDebugger">
      <Param name="Service" value="##ServiceName##" />
		</Monitor>
	</Agent>

	<Agent name="LinRemoteAgent" location="tcp://##RemoteAgentIP##:9001">
		<Monitor class="LinuxCrashMonitor"/>
	</Agent>

	<Agent name="OSXRemoteAgent" location="tcp://##RemoteAgentIP##:9001">
		<Monitor class="CrashReporter"/>
	</Agent>


	<!-- Default test case -->
	<Test name="Default">
		
		<StateModel ref="AgentToHost"/>
		
		<Agent ref="WinRemoteAgent" platform="windows" />
		<Agent ref="LinRemoteAgent" platform="linux" />
		<Agent ref="OSXRemoteAgent" platform="osx" />
		
		<Publisher class="Tcp" name="TcpHandler">
			<Param name="Host" value="##TargetHost##" />
			<Param name="Port" value="##TargetPort##" />
		</Publisher>
		
		<Strategy class="##Strategy##"/>
		<Logger class="logger.Filesystem" >
			<Param name="Path" value="##LoggerPath##" />
		</Logger>
		
	</Test>

</Peach>
