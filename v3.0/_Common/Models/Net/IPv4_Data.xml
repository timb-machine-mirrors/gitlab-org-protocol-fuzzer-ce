<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://peachfuzzer.com/2012/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://peachfuzzer.com/2012/Peach ../peach.xsd" 
       author="Deja Vu Security, LLC" description="Internet Protocol Version 4 PIT" version="0.0.2">
	<!-- Copyright (c) Deja Vu Security, LLC. 2013 -->
		
	<Include ns="DataModels" src="file:##Path##/_Common/Models/Net/ICMPv4_Data.xml"/>
	
  <!-- IPv4 Options -->
  <DataModel name="OptionsBlock">
    <Flags size="8" name="OptionType" endian="big">
      <Flag name="CopiedFlag" position="0" size="1">
      <Flag name="OptionClass" position="1" size="2">
      <Flag name="OptionNumber" position="3" size="5">
    </Flags>
  </DataModel>
  
  <DataModel name="ExtendedOptionsBlock">
    <Block name="BaseOption" ref="OptionsBlock" />
    <Number name="OptionLength" size="8" endian="big">
      <Relation type="size" of="ExtendedOptionsBlock"/>
    </Number>
    <Blob name="OptionData" />
  </DataModel>
  
  <!--TODO Does not currently Crack,
  add individual datamodels and tokens,
  requires fix to issue #222-->
  <DataModel name="IPv4Options"> 
    <Choice>
      <Block name="EndOfOptionList" ref="OptionsBlock" />
      <Block name="NoOp" ref="OptionsBlock" />
      <Block name="Security" ref="ExtendedOptionsBlock" />
      <Block name="LooseSourceRouting" ref="ExtendedOptionsBlock" />
      <Block name="StrictSourceRouting" ref="ExtendedOptionsBlock" />
      <Block name="RecordRoute" ref="ExtendedOptionsBlock" />
      <Block name="StreamID" ref="ExtendedOptionsBlock" />
      <Block name="Timestamp" ref="ExtendedOptionsBlock" />
    </Choice>
  </DataModel>
        
  <!-- IP Packet RFC791 --> 
  <DataModel name="IPv4">
    <Block name="Header">
      <Flags size="16" endian="big">
        <Flag name="Version" position="0" size="4" valueType="hex" value="04" token="true"/>
        <Flag name="HeaderLength" position="4" size="4" valueType="hex">
          <Relation type="size" of="Header" expressionGet="size * 4" expressionSet="size / 4"/>
        </Flag>
        <Flag name="DSCP" position="8" size="6" valueType="hex" value="00"/>
        <Flag name="ECN" position="14" size="2" valueType="hex" value="00"/>
      </Flags>
      <Number name="TotalLength" size="16" endian="big" valueType="hex">
        <Relation type="size" of="IPv4"/>
      </Number>
      <Number name="Identification" size="16" endian="big" value="0"/>
      <Flags name="Flags" size="16" endian="big">
        <Flag name="Reserved" position="0" size="1" valueType="hex" value="00"/>
        <Flag name="DF" position="1" size="1" valueType="hex" value="01"/>
        <Flag name="MF" position="2" size="1" valueType="hex" value="00"/>
        <Flag name="FragmentOffset" position="3" size="13" valueType="hex" value="00 00"/>
      </Flags>
      <Number name="TTL" size="8" endian="big" valueType="hex" value="40"/>
      <Number name="Protocol" size="8" endian="big" valueType="hex" value="01"/>
      <Number name="Checksum" size="16" endian="big">
        <Fixup class="checksums.IcmpChecksumFixup">
          <Param name="ref" value="Header"/>
        </Fixup>
      </Number>
      <Block name="SrcBlock" length="4"> <!--Used for cracking-->
        <String name="SrcIP" value="##SourceIPv4##" mutable="false">
          <Transformer class="Ipv4StringToOctet" />
        </String>
      </Block>
      <Block name="DstBlock" length="4"> <!--Used for cracking-->
        <String name="DestIP" value="##TargetIPv4##" mutable="false"> <!--These fields must be nonmutable on windows-->
          <Transformer class="Ipv4StringToOctet" />
        </String>
      </Block>
      <Block name="Options" />
        <Block name="Option" ref="IPv4Options" minOccurs="0" />
        <Padding alignment="32" />
      </Block>
    </Block>
    <Block name="Payload" ref="DataModels:ICMPv4Header"/>
  </DataModel>
</Peach>
<!--END-->
