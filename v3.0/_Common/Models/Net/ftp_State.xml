<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://peachfuzzer.com/2012/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://peachfuzzer.com/2012/Peach ../peach.xsd"  
       author="Deja Vu Security, LLC" description="File Transfer Protocol PIT StateModels" version="0.0.2">
	<!-- Copyright (c) Deja Vu Security, LLC 2013 -->
	
	<Include ns="DataModels" src="file:##Path##/_Common/Models/Net/ftp_Data.xml"/>
	<PythonPath path="##Path##/_Common/Models/Net/"/>
	<Import import="FTP"/>	
	
	<!-- FTP simple state model -->
	<StateModel name="AgentToHost" initialState="InputUserName">
		<State name="InputUserName">
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="DataModels:ServerReadyForUser" />
			</Action>
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="DataModels:USER" />
			</Action>
			<Action type="changeState" ref="InputPasswd"/>
		</State>

		<State name="InputPasswd">
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="DataModels:ServerUserNeedsPass" />
			</Action>
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="DataModels:PASS" />
			</Action>
			<Action type="changeState" ref="TestConnection"/>
		</State>

		<State name="TestConnection">
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="DataModels:ServerLoggedIn" />
			</Action>
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="DataModels:NOOP" />
			</Action>
			<Action type="changeState" ref="MakeDir"/>
		</State>

		<State name="MakeDir">
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="DataModels:ServerOk" />
			</Action>
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="DataModels:MKD" />
			</Action>
			<Action type="changeState" ref="DelDir"/>
		</State>

		<State name="DelDir">
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="DataModels:DirCreated" />
			</Action>
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="DataModels:RMD" />
			</Action>
			<Action type="changeState" ref="Ready"/>
		</State>

		<State name="Ready">
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="DataModels:ResponseTemplate" />
				<!-- <DataModel ref="Response" /> -->
			</Action>
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="DataModels:Request" />
			</Action>
		</State>
	</StateModel>
	
	<StateModel name="HostToAgent" initialState="StartServer">
		<State name="StartServer">
      <Action type="start" publisher="TcpHandler"/>

      <Action type="call" method="launchProgram" publisher="Peach.Agent"/>

      <Action type="accept" publisher="TcpHandler"/>

			<Action name="Next" type="changeState" ref="InputUserName"/>
    </State>
	
		<State name="InputUserName">
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="DataModels:ServerReadyForUser"/>
				<Data DataModel="DataModels:ServerReadyForUser">
					<Field name="LineModes.OneLine.Explaination" value="vsFTPd 2.3.5"/>
				</Data>
			</Action>
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="DataModels:USER"/>
			</Action>
			<Action type="changeState" ref="InputPasswd"/>
		</State>

		<State name="InputPasswd">
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="DataModels:ServerUserNeedsPass"/>
				<Data DataModel="DataModels:ServerUserNeedsPass">
					<Field name="LineModes.OneLine.Explaination" value="Please specify the password"/>
				</Data>
			</Action>
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="DataModels:PASS"/>
			</Action>
			
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="DataModels:ServerLoggedIn"/>
			</Action>
			
			<Action type="changeState" ref="Ready"/>
		</State>

		<State name="Ready">
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="DataModels:Request"/>
			</Action>
			
			<Action name="Done" type="changeState" ref="Done" when="StateModel.states['Ready'].actions[0].dataModel.find('EmptyPacket') != None"/>
			
			<Action type="output" publisher="TcpHandler" onStart="FTP.set_response(self)">
				<DataModel ref="DataModels:ResponseTemplate"/>
			</Action>
			
			<Action name="Quit" type="changeState" ref="Done" when="str(StateModel.states['Ready'].actions[0].dataModel.find('Command')) == 'QUIT'"/>
		
			<Action name="ReadNext" type="changeState" ref="Ready"/>
		</State>
		
		<State name="Done">
			<Action type="close" publisher="TcpHandler"/>
			<Action type="call" method="exitProgram" publisher="Peach.Agent"/>
		</State>
	</StateModel>
</Peach>
