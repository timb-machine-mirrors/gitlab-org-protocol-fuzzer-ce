<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://peachfuzzer.com/2012/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://peachfuzzer.com/2012/Peach ../peach.xsd"  
       author="Deja Vu Security, LLC" description="File Transfer Protocol PIT StateModels" version="0.0.2">
	<!-- Copyright (c) Deja Vu Security, LLC 2013 -->
	
	<Include ns="DataModels" src="file:##Path##/_Common/Models/Net/ftp_Data.xml"/>

	<!-- FTP simple state model -->
	<StateModel name="AgentToHost" initialState="InputUserName">
		<State name="InputUserName">
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="DataModels:ServerReadyForUser" />
			</Action>
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="DataModels:USER" />
			</Action>
			<Action type="changeState" ref="InputPasswd"/>
		</State>

		<State name="InputPasswd">
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="DataModels:ServerUserNeedsPass" />
			</Action>
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="DataModels:PASS" />
			</Action>
			<Action type="changeState" ref="TestConnection"/>
		</State>

		<State name="TestConnection">
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="DataModels:ServerLoggedIn" />
			</Action>
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="DataModels:NOOP" />
			</Action>
			<Action type="changeState" ref="MakeDir"/>
		</State>

		<State name="MakeDir">
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="DataModels:ServerOk" />
			</Action>
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="DataModels:MKD" />
			</Action>
			<Action type="changeState" ref="DelDir"/>
		</State>

		<State name="DelDir">
			<Action type="input" publisher="TcpHandler">
				<!--DataModel ref="DataModels:DirCreated" /--><!--TODO-->
				<DataModel ref="DataModels:ResponseTemplate" />
			</Action>
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="DataModels:RMD" />
			</Action>
			<Action type="changeState" ref="Ready"/>
		</State>

		<State name="Ready">
			<Action type="input" publisher="TcpHandler">
				<DataModel ref="DataModels:ResponseTemplate" />
				<!-- <DataModel ref="Response" /> -->
			</Action>
			<Action type="output" publisher="TcpHandler">
				<DataModel ref="DataModels:Request" />
			</Action>
		</State>
	</StateModel>
</Peach>