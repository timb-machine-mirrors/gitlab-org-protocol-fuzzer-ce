<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://phed.org/2008/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://phed.org/2008/Peach /peach/peach.xsd" author="Deja vu Security" version="1">

  <Include ns="default" src="file:defaults.xml"/>

  <Import from="JPGBytePacking" import="*"/>

  <!--*********** BEGIN EXIF **************-->
  <DataModel name="TIFFHeader">
    <Choice name="EndianChoice" >
      <String name="EndianLittle" value="II" token="true" nullTerminated="false" length="2" mutable="false"/>
      <String name="EndianBig" value="MM" token="true" nullTerminated="false" length="2" mutable="false"/>
    </Choice>

    <Blob name="Tag" value="2A 00" valueType="hex" token="true" mutable="false"/>

  </DataModel>

  <DataModel name="IFDEntry">
    <Number name="Tag" signed="false" size="16" />
    <Number name="Type" signed="false" size="16" />
    <Number name="ComponentCount" signed="false" size="32" />
    <Blob name="Data" length="4" />
  </DataModel>
  
  <DataModel name="IFD">
    <Number size="16" name="DirEntries" signed="false">
      <Relation type="count" of="TheEntry"/>
    </Number>
    <Block name="TheEntry" ref="IFDEntry" minOccurs="1" maxOccurs="3000" />
  </DataModel>

  <DataModel name="EXIF">
    <Block name="TheTIFFHeader" ref="TIFFHeader" />
    <Number size="8" signed="false" name="OffsettoFirstIFD">
      <Relation type="offset" of="TheIFD" relative="true" relativeTo="TheTIFFHeader"/>
    </Number>
    <Block name="TheIFD" ref="IFD"/>
  </DataModel>
  <!-- ********** END EXIF *********** -->


  
  <!-- ******** Marker Segmeent ******** -->
  <DataModel name="MarkerSegment">
    <Blob name="Magic" token="true" length="1" value="FF" valueType="hex"/>
    <Blob name="Type" length="1" constraint="value != 0 and value != 255" />

    <Number endian="big" name="Length" size="16" signed="false">
      <Relation type="size" of="SegmentData" expressionGet="size - 2" expressionSet="size + 2"/>
    </Number>

    <Blob name="SegmentData">
      <Relation type="size" from="Length" />
    </Blob>
    
  </DataModel>

  <!-- ******** Entroyp Coded Data Segment ******** -->
  <DataModel name="EntropyCodedDataSegment">
    <Blob name="EntropyCodedData" constraint="value > 0"/>
  </DataModel>


  <!-- ********* Frame Header ********* -->
  <DataModel name="FrameHeader" ref="MarkerSegment">
    <Block name="Type">
      <Choice name="TypeChoice">
        <Blob name="BaseLineDCT"    length="1" valueType="hex" token="true" value="C0"/>
        <Blob name="ExtenedSeqDCT"  length="1" valueType="hex" token="true" value="C1"/>
        <Blob name="ProgressiveDCT" length="1" valueType="hex" token="true" value="C2"/>
        <Blob name="LoselessSeq"    length="1" valueType="hex" token="true" value="C3"/>

        <Blob name="DifffSeqDCT"    length="1" valueType="hex" token="true" value="C5"/>
        <Blob name="DiffProgDCT"    length="1" valueType="hex" token="true" value="C6"/>
        <Blob name="DiffLossSeq"    length="1" valueType="hex" token="true" value="C7"/>
        
        <Blob name="Reserved"       length="1" valueType="hex" token="true" value="C8"/>

        <Blob name="NonDiffSeqDCT"  length="1" valueType="hex" token="true" value="C9"/>
        <Blob name="NonDiffProgDCT" length="1" valueType="hex" token="true" value="CA"/>
        <Blob name="NonDiffLosless" length="1" valueType="hex" token="true" value="CB"/>

        <Blob name="DiffDiffSeqDCT" length="1" valueType="hex" token="true" value="CD"/>
        <Blob name="DiffDiffProDCT" length="1" valueType="hex" token="true" value="CE"/>
        <Blob name="DiffDiffLosDCT" length="1" valueType="hex" token="true" value="CF"/>
      </Choice>
    </Block>
    
    <Block name="SegmentData">
      <Relation type="size" from="Length" />
      
      <Number endian="big" name="SamplePrecision" size="8" signed="false" />
      <Number endian="big" name="Y" size="16" signed="false" />
      <Number endian="big" name="X" size="16" signed="false" />
      <Number endian="big" name="Nf" size="8" signed="false">
        <Relation type="count" of="ImageComponent"/>
      </Number>

      <Block name="ImageComponent" maxOccurs="255">
        <Relation type="count" from="Nf"/>
        <Number endian="big" name="C" size="8" signed="false"/>
        <Flags name="ImageComponentFlags" size="8">
          <Flag name="H" position="4" size="2" />
          <Flag name="V" position="0" size="2" />
        </Flags>
        <Number endian="big" name="Tq" size="8" signed="false"/>
      </Block>

    </Block>
  </DataModel>


  <!-- SCAN HEADER -->
  <DataModel name="ScanHeader" ref="MarkerSegment">
    <Blob name="Type" value="DA" length="1" valueType="hex" token="true" />
    <Block name="SegmentData">
      <Relation type="size" from="Length" />
      
      <Number endian="big" name="Ns" size="8" signed="false">
        <Relation type="count" of="ImageComponentFlags1"/>
      </Number>

      <Block name="ImageComponentFlags1" minOccurs="0" maxOccurs="255">
        <Relation type="count" from="Ns"/>

        <Number endian="big" name="Cs" size="8" signed="false" />
        
        <Flags name="TheImageComponentFlags1" size="8" >
          <Flag name="Td" position="4" size="2" />
          <Flag name="Ta" position="0" size="2" />
        </Flags>
      </Block>
      
      <Number endian="big" name="Ss" size="8" signed="false" />
      <Number endian="big" name="Se" size="8" signed="false" />

      <Flags name="ImageComponentFlags2" size="8">
        <Flag name="Ah" position="4" size="4" />
        <Flag name="Al" position="0" size="4" />
      </Flags>

    </Block>
  </DataModel>


  <!-- *************** Quantized Table ********--> 
  <DataModel name="QuantizedTableSpecification" ref="MarkerSegment">
    <Blob name="Type" value="DB" length="1" valueType="hex" token="true" />
    <Block name="SegmentData">
      <Relation type="size" from="Length" />
      
      <Block name="QuanTable" minOccurs="1" maxOccurs="3000">
        
        <Flags size="8">
          <Flag name="Pq" position="4" size="1" />
          <Flag name="Tq" position="0" size="2" />
        </Flags>
        
        <Blob name="qTable" length="64" />
      
      </Block>
    </Block>
  </DataModel>

  <!-- ************ Huffman Table Specification ************ -->
  <DataModel name="HuffmanTableSpecification" ref="MarkerSegment">
    <Blob name="Type" value="C4" length="1" valueType="hex" token="true" />
    <Block name="SegmentData">
      <Relation type="size" from="Length" />
      
      <Block name="" minOccurs="1" maxOccurs="3000">
      <Flags name="HuffmanTableSpecificationFlags" size="8">
        <Flag name="Tc" position="4" size="1" />
        <Flag name="Th" position="0" size="2" />
      </Flags>
        <Block name="TableDefs">
          <Number endian="big" size="8" signed="false" name="T1">
            <Relation type="count" of="V1"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="T2">
            <Relation type="count" of="V2"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="T3">
            <Relation type="count" of="V3"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="T4">
            <Relation type="count" of="V4"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="T5">
            <Relation type="count" of="V5"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="T6">
            <Relation type="count" of="V6"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="T7">
            <Relation type="count" of="V7"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="T8">
            <Relation type="count" of="V8"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="T9">
            <Relation type="count" of="V9"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="T10">
            <Relation type="count" of="V10"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="T11">
            <Relation type="count" of="V11"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="T12">
            <Relation type="count" of="V12"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="T13">
            <Relation type="count" of="V13"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="T14">
            <Relation type="count" of="V14"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="T15">
            <Relation type="count" of="V15"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="T16">
            <Relation type="count" of="V16"/>
          </Number>
        </Block>
        
        <Block name="TableVals">
          <Number endian="big" size="8" signed="false" name="V1" minOccurs="0" maxOccurs="255">
            <Relation type="count" from="T1"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="V2" minOccurs="0" maxOccurs="255">
            <Relation type="count" from="T2"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="V3" minOccurs="0" maxOccurs="255">
            <Relation type="count" from="T3"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="V4" minOccurs="0" maxOccurs="255">
            <Relation type="count" from="T4"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="V5" minOccurs="0" maxOccurs="255">
            <Relation type="count" from="T5"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="V6" minOccurs="0" maxOccurs="255">
            <Relation type="count" from="T6"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="V7" minOccurs="0" maxOccurs="255">
            <Relation type="count" from="T7"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="V8" minOccurs="0" maxOccurs="255">
            <Relation type="count" from="T8"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="V9" minOccurs="0" maxOccurs="255">
            <Relation type="count" from="T9"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="V10" minOccurs="0" maxOccurs="255">
            <Relation type="count" from="T10"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="V11" minOccurs="0" maxOccurs="255">
            <Relation type="count" from="T11"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="V12" minOccurs="0" maxOccurs="255">
            <Relation type="count" from="T12"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="V13" minOccurs="0" maxOccurs="255">
            <Relation type="count" from="T13"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="V14" minOccurs="0" maxOccurs="255">
            <Relation type="count" from="T14"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="V15" minOccurs="0" maxOccurs="255">
            <Relation type="count" from="T15"/>
          </Number>
          <Number endian="big" size="8" signed="false" name="V16" minOccurs="0" maxOccurs="255">
            <Relation type="count" from="T16"/>
          </Number>

        </Block>
        
      </Block>
    </Block>
  </DataModel>


  <!-- *********** Arithmetic Conditioning ********** -->
  <DataModel name="ArithmeticConditioningTableSpecification" ref="MarkerSegment">
    <Blob name="Type" value="CC" length="1" valueType="hex" token="true" />
    <Block name="SegmentData">
      <Relation type="size" from="Length" />
      
      <Block minOccurs="1" maxOccurs="3000">
        <Flags name="ArithmeticConditioningTableSpecificationFlags" size="8">
          <Flag name="Tc" position="4" size="1"/>
          <Flag name="Tb" position="0" size="2"/>
        </Flags>
        <Number endian="big" name="Cs" signed="false" size="8"/>
      </Block>
    </Block>
  </DataModel>
 
  <!-- ********* Restart Interval Def ***********-->
  <DataModel name="RestartIntervalDefinition" ref="MarkerSegment">
    <Blob name="Type" value="DD" length="1" valueType="hex" token="true" />
    <Block name="SegmentData">
      <Relation type="size" from="Length" />
      
      <Number endian="big" name="Ri" signed="false" size="16" />
    </Block>
  </DataModel>
 
  <!-- ********* Comment Data ***************-->
  <DataModel name="Comment" ref="MarkerSegment">
    <Blob name="Type" value="FE" length="1" valueType="hex" token="true" />
    <Block name="SegmentData">
      <Relation type="size" from="Length" />
      
      <Blob name="CommentBlob" />
    </Block>
  </DataModel>
  
  <!--*********** Generic App Data *********** -->
  <DataModel name="GenericApplicationData" ref="MarkerSegment">
    <Number endian="big" name="Type" size="8" constraint="value &gt;= 224 and value&lt;=239" signed="false"/>
  </DataModel>

  <!-- ********** JFIF Format Data ************ -->
  <DataModel name="JFIFFormatData" ref="GenericApplicationData">
    
    <Number name="Type" endian="big" size="8" value="E0" valueType="hex" signed="false" token="true" />
    
    <Block name="SegmentData">
      <Relation type="size" from="Length" />
      
      <Blob name="JFIFIdentifier" token="true" value="4A 46 49 46 00" valueType="hex"/>
      
      <Blob name="VersionHigh" length="1" value="01" valueType="hex" token="true" />
      <Blob name="VersionLow" length="1" value="02" valueType="hex" />
      
      <Number endian="big" name="Units" size="8" signed="false" />

      <Number endian="big" name="Xdensity" size="16" signed="false" />
      <Number endian="big" name="Ydensity" size="16" signed="false" />


      <Choice name="GridChoice">

        <Block name="Edge">
          <Number name="Xthumbnail" size="8" signed="false" value="0">
            <Relation type="count" of="xScan" />
          </Number>
          <Number name="Ythumbnail" size="8" signed="false" token="true" value="0" />

          <Block name="xScan" minOccurs="0" maxOccurs="255">
            <Relation type="count" from="Xthumbnail"/>
            <Blob name="RGB" length="3" />
          </Block>
        </Block>

        <Block name="Normal">
          <Number endian="big" name="Xthumbnail" size="8" signed="false" >
            <Relation type="count" of="xScan"/>
          </Number>
          <Number endian="big" name="Ythumbnail" size="8" signed="false" >
            <Relation type="count" of="yScan" />
          </Number>
          
          <Block name="yScan" minOccurs="0" maxOccurs="255">
            <Relation type="count" from="Ythumbnail"/>
            <Block name="xScan" minOccurs="0" maxOccurs="255">
              <Relation type="count" from="Xthumbnail"/>
              <Blob name="RGB" length="3" />
            </Block>
          </Block>
          
        </Block>
      </Choice>
      
    </Block>
  </DataModel>

  <!-- ******** JFIF Extenstion ************** -->
  <DataModel name="JFIFExtension" ref="GenericApplicationData">
    <Number name="Type" endian="big" size="8" value="224" signed="false" token="true" />
    <Blob name="JFXXIdentifier" token="true" value="4A 46 58 58 00" valueType="hex"/>
    
    <Number endian="big" name="ExtensionCode" size="8" signed="false"/>
    <Blob name="ExtensionData" />
  </DataModel>

  <!-- ********** App Data ************ -->
  <DataModel name="ApplicationData">
    <Choice name="AppDataChoice">
      <Block name="TheJFIFFormatData" ref="JFIFFormatData"/>
      <Block name="TheJFIFExtension" ref="JFIFExtension" />
      <Block name="TheGenericApplicationData" ref="GenericApplicationData" />
    </Choice>
  </DataModel>

  <!-- ********** Jpeg Data marker segment ****-->
  <DataModel name="JPEGData" ref="MarkerSegment">
    <Number endian="big" name="Type" constraint="value &gt;= 240 and value&lt;=253" size="8" />
  </DataModel>


  <!-- ***** Define Number of Lines ********* -->
  <DataModel name="DefineNumberofLines" ref="MarkerSegment">
    <Blob name="Type" value="DC" length="1" valueType="hex" token="true" />
    <Block name="SegmentData">
      <Relation type="size" from="Length" />
      
      <Number endian="big" name="NL" size="16" signed="false" />
    </Block>
  </DataModel>
  
  

  <!-- ********* Tables Misc *********  -->
  <DataModel name="TablesMisc">
    <Choice name="TablesChoice" minOccurs="0" maxOccurs="3000">
      <Block name="TheApplicationData" ref="ApplicationData"/>
      <Block name="TheQuantizedTableSpecification" ref="QuantizedTableSpecification"/>
      <Block name="TheHuffmanTableSpecification" ref="HuffmanTableSpecification"/>
      <Block name="TheArithmeticConditioningTableSpecification" ref="ArithmeticConditioningTableSpecification"/>
      <Block name="TheRestartIntervalDefinition" ref="RestartIntervalDefinition"/>
      <Block name="TheComment" ref="Comment"/>
    </Choice>
  </DataModel>


  <!-- Hierarchical Mode: Progression Definitioan -->
  <DataModel name="DefineHierarchicalProgression" ref="FrameHeader">
    <Blob name="Type" value="DE" length="1" valueType="hex" token="true" />
  </DataModel>

  <DataModel name="ExpandSegment" ref="MarkerSegment">
    <Blob name="Type" value="DF" length="1" valueType="hex" token="true" />
    <Block name="SegmentData">
      <Relation type="size" from="Length" />
      
      <Flags name="ExpandSegmentFlags" size="8">
        <Flag name="Eh" position="4" size="1" />
        <Flag name="Ev" position="0" size="1" />
      </Flags>
    </Block>
  </DataModel>


  <!-- Standard meta frame -->
  <DataModel name="Frame">

    <Block name="TheTablesMisc" ref="TablesMisc" />
    <Block name="TheFrameHeader" ref="FrameHeader"/>
    <Block name="Scan" minOccurs="1" maxOccurs="3000">
      <Block name="ScanTablesMisc" ref="TablesMisc" />
      <Block name="TheScanHeader" ref="ScanHeader"/>
      <Block name="TheEntropyCodedDataSegment" ref="EntropyCodedDataSegment" />
    </Block>
  </DataModel>

  <!-- Hierarchical Mode Frame  -->
  <DataModel name="HierarchicalMode">
    <Block name="DHP" ref="DefineHierarchicalProgression"/>
    <Block name="aFrame" ref="Frame" minOccurs="1" maxOccurs="3000">
      <Block name="FrameHeader">
        <Block name="EXP" ref="ExpandSegment" minOccurs="0" maxOccurs="1"/>
        <Block name="ActualHeader" ref="FrameHeader" />
      </Block>
    </Block>
  </DataModel>
  
  <!-- MAIN Image container -->
  <DataModel name="JPG-JFIF">
    <Blob name="SOIMagic" value="FF D8" valueType="hex" token="true" length="2" mutable="false" />
    <Choice name="FrameChoice" >
      <Block name="TheFrame" ref="Frame" />
      <Block name="TheHierarchicalMode" ref="HierarchicalMode" />
    </Choice>
    <Blob name="EOIMagic" value="FF D9" valueType="hex" token="true" length="2" mutable="false" />
  </DataModel>

  <!-- STATE MODEL SECTION -->
  <StateModel name="StateModel" initialState="Initial">
    <State name="Initial">

      <Action name="WriteFileFromSample" type="output" publisher="writer">
        <DataModel name="Jpeg" ref="JPG-JFIF" />
        <Data name="data" fileName="SeedFile.jpg" />
      </Action>

      <Action name="CloseFile"  type="close" publisher="writer" />
      <Action name="Launch" type="call" method="FuzzMe" publisher="launch" />
    </State>
  </StateModel>


  <!-- ***************
       AGENT SECTION  
      *************** -->

  <!-- WINDOWS
  <Agent name="Agent">

    <Monitor class="debugger.WindowsDebugEngine">
      <Param name="CommandLine" value="C:\\path\\to\\target.exe fuzzed.jpg"/>
      <Param name="StartOnCall" value="FuzzMe"/>
    </Monitor>

    <Monitor class="process.PageHeap">
      <Param name="Executable" value="target.exe"/>
    </Monitor>
  </Agent>
 -->
  <!-- LINUX 
    <Agent name="Agent" location="http://127.0.0.1:9000">
      <Monitor class="debugger.UnixDebugger">
        <Param name="Command" value="/bin/target" />
        <Param name="Params" value="fuzzed.jpg" />
        <Param name="StartOnCall" value="FuzzMe" />
      </Monitor>
    </Agent> 
    -->

  <!-- OSX
    <Agent name="Agent" location="http://127.0.0.1:9000">
      <Monitor class="osx.CrashWrangler">
        <Param name="Command" value="/Applications/Target/TargetName" />
        <Param name="Arguments" value="fuzzed.jpg" />
        <Param name="ExecHandler" value="./exc_handler" />
        <Param name="StartOnCall" value="FuzzMe" />
      </Monitor>
    </Agent>
     -->


  <!-- **************
        TEST SECTION  
       ************** -->
  <Test name="Test">

    <Agent ref="Agent"/>
    <StateModel ref="StateModel" />

    <Publisher name="writer" class="file.FileWriter">
      <Param name="Filename" value="fuzzed.jpg" />
    </Publisher>

    <!-- Command Line Launcher: Win/Lin/OSX  With Debugger -->
    <Publisher name="launch" class="process.DebuggerLauncher"/>

    <!-- GUI Launcher: WINDOWS ONLY -->
    <!--
     <Publisher name="launch" class="process.DebuggerLauncherGui"> 
      <Param name="WindowName" value="GUI Window Name" /> 
     </Publisher> 
     -->

  </Test>

  <!-- **************
        RUN SECTION  
       ************** -->
  <Run name="DefaultRun" description="Default Run">
    <Test ref="Test" />
    <Logger class="logger.Filesystem">
      <Param name="path" value=".\logs\"/>
    </Logger>
  </Run>


</Peach>
