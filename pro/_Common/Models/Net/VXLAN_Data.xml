<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://peachfuzzer.com/2012/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://peachfuzzer.com/2012/Peach ../peach.xsd"  
       author="Deja Vu Security, LLC" description="Virtual Extensible LAN PIT DataModels" version="0.0.2">
  <!-- Copyright (c) Deja Vu Security, LLC. 2012 - 2013 -->

	<!-- http://tools.ietf.org/html/draft-mahalingam-dutt-dcops-vxlan-04 -->

	<Include ns="ICMP" src="file:##PitLibraryPath##/_Common/Models/Net/ICMPv6_Data.xml"/>
	<Include ns="Ethernet" src="file:##PitLibraryPath##/_Common/Models/Net/Ethernet_Data.xml"/>
	<Include ns="VLAN" src="file:##PitLibraryPath##/_Common/Models/Net/VLAN_Data.xml"/>
	
	<Include ns="IPv4" src="file:##PitLibraryPath##/_Common/Models/Net/IPv4_Data.xml"/>
	<Include ns="IPv6" src="file:##PitLibraryPath##/_Common/Models/Net/IPv6_Data.xml"/>
	
	<Include ns="TCP" src="file:##PitLibraryPath##/_Common/Models/Net/TCP_Data.xml"/>
	<Include ns="UDPv4" src="file:##PitLibraryPath##/_Common/Models/Net/UDPv4_Data.xml"/>


  <DataModel name="VXLANHeader">
		<Flags size="8" endian="big" >
			<Flag position="4" value="1" size="1"/>
		</Flags>
		<Number name="LargeReserve" size="24" endian="big"/>
		<Number name="VNI" 	    size="24" value="7639335" endian="big"/>
		<Number name="SmallReserve" size="8" endian="big"/>
		<Block name="EtherHeader" ref="Ethernet:Frame">
			<Blob name="TypeOrLen" valueType="hex" value="0800"/>
		</Block>
		<Block name="VXLANPayload"/>
	</DataModel>

  <DataModel name="VXLAN">
    <Block name="OuterEtherHeader" ref="Ethernet:Frame">
      <Blob name="Dest" valueType="hex" value="##OuterTargetMAC##"/>
      <Blob name="Src"  valueType="hex" value="##OuterSourceMAC##"/>
      <Blob name="TypeOrLen" valueType="hex" value="0800"/>
    </Block>
    <Block name="OuterIP" ref="IPv4:Packet">
			<Number name="Header.Protocol" size="8" endian="big" value="17"/>
			<Blob name="Header.SrcIP" valueType="ipv4" length="4" value="##OuterSourceIPv4##"/>
			<Blob name="Header.DestIP" valueType="ipv4" length="4" value="##OuterTargetIPv4##"/>
      <Block name="IPv4Payload" ref="UDPv4:Packet">
				<Number name="Header.SrcPort"  size="16" endian="big" value="9029"/>
				<Number name="Header.DestPort" size="16" endian="big" value="4789"/>
				<Number name="Header.Checksum" size="16" endian="big"/> <!-- VXLAN has no inner CRC -->
				<Block name="UdpPayload">
					<Block name="VXHeader" ref="VXLANHeader">
						<Blob name="EtherHeader.Type" valueType="hex" value="0800"/>
						<Block name="VXLANPayload">
							<Block name="InnerIP" ref="IPv4:Packet">
								<Number name="Header.Protocol" size="8" endian="big" value="17"/>
								<Block name="IPv4Payload" ref="UDPv4:Packet">
									<Number name="Header.SrcPort" size="16" endian="network" value="1234"/>
									<Number name="Header.DestPort" size="16" endian="network" value="1234"/>
									<Block name="UdpPayload">
										<Blob value="AAAAAA"/>
									</Block>
								</Block>
							</Block>
						</Block>
					</Block>
				</Block>
      </Block>
    </Block>
  </DataModel>

	<!-- VXLAN Empty IPv4 Frame -->
	<DataModel name="IPv4EmptyPacketInVxlan">
		<Block name="VXLAN" ref="VXLAN">
			<Number name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.Header.Protocol" size="8" endian="big" value="1"/>
			<Block name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.IPv4Payload"/>
		</Block>
	</DataModel>
  
	<!-- VXLAN Empty IPv6 Frame -->
	<DataModel name="IPv6EmptyPacketInVxlan">
		<Block name="VXLAN"  ref="VXLAN">
			<Blob name="OuterIP.IPv4Payload.UdpPayload.VXHeader.EtherHeader.Type" valueType="hex" value="86dd"/>
			<Block name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload">
				<Block name="InnerIP" ref="IPv6:IPv6Header">
					<Number name="NextHeader" size="8" endian="big" value="59"/>
					<Number name="PayloadLength" value="0" size="16"/>
					<Block name="IPv6Payload">
					</Block>
				</Block>
			</Block>
		</Block>
	</DataModel>

	<DataModel name="IPv6ICMPInVxlan">
		<!-- good -->
		<Block name="VXLAN"  ref="IPv6EmptyPacketInVxlan">
			<Number name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.PayloadLength" 
							size="16" endian="big" value="65535">
				<Relation type="size" of="IPv6Payload" />
			</Number>
			<Number name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.NextHeader" size="8" endian="big" value="58"/>
			<Block name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.IPv6Payload" ref="ICMP:Packet"/>
		</Block>
	</DataModel>

	<DataModel name="IPv6HopByHopInVxlan">
		<!-- good -->
		<Block name="VXLAN"  ref="IPv6EmptyPacketInVxlan">
			<Number name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.PayloadLength" 
							size="16" endian="big" value="65535">
				<Relation type="size" of="IPv6Payload" />
			</Number>
			<Number name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.NextHeader" size="8" endian="big" value="0"/>
			<Block name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.IPv6Payload" ref="IPv6:HopByHop"/>
		</Block>
	</DataModel>


	<!-- A jumbogram would have to be passed within another jumbogram -->
	
	<!-- <DataModel name="IPv6JumbogramInVxlan"> -->
	<!-- 	<Block name="VXLAN"  ref="IPv6EmptyPacketInVxlan"> -->
	<!-- 		<Number name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.PayloadLength" -->
	<!-- 						size="16" endian="big" value="0"/> -->
	<!-- 		<Number name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.NextHeader" size="8" endian="big" value="0"/> -->
	<!-- 		<Block name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.IPv6Payload" ref="IPv6:JumboFrame"/> -->
	<!-- 	</Block> -->
	<!-- </DataModel> -->


	<DataModel name="IPv6Fragment1InVxlan">
		<!-- good -->
		<Block name="VXLAN"  ref="IPv6EmptyPacketInVxlan">
			<Number name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.PayloadLength" 
							size="16" endian="big" value="65535">
				<Relation type="size" of="IPv6Payload" />
			</Number>
			<Number name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.NextHeader" size="8" endian="big" value="44"/>
			<Block name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.IPv6Payload" ref="IPv6:Fragment">
				<Flags name="Flags" size="16" endian="big">
					<Flag name="Offset" size="13" position="0" value="0"/>
					<Flag name="Res" size="2" position="13"/>
					<Flag name="Mflag" size="1" position="15" value="1"/>
				</Flags>
				<Number name="Identification" size="32" endian="big" value="374625"/>
				<Blob name="Data" length="12"/>
			</Block>
		</Block>
	</DataModel>

	<DataModel name="IPv6Fragment2InVxlan">
		<!-- good -->
		<Block name="VXLAN"  ref="IPv6Fragment1InVxlan">
			<Flags name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.IPv6Payload.Flags" size="16" endian="big">
					<Flag name="Offset" size="13" position="0" value="12"/> <!-- This is relative to the last frag... -->
					<Flag name="Res" size="2" position="13"/>
					<Flag name="Mflag" size="1" position="15" value="1"/>
			</Flags>
		</Block>
	</DataModel>


	<DataModel name="IPv6Fragment3InVxlan">
		<!-- good -->
		<Block name="VXLAN"  ref="IPv6Fragment1InVxlan">
			<Flags name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.IPv6Payload.Flags" size="16" endian="big">
					<Flag name="Offset" size="13" position="0" value="24"/> <!-- This is relative to the last frag... -->
					<Flag name="Res" size="2" position="13"/>
					<Flag name="Mflag" size="1" position="15" value="0"/>
			</Flags>
		</Block>
	</DataModel>

	<DataModel name="IPv6DestinationOptionsInVxlan">
		<!-- good -->
		<Block name="VXLAN"  ref="IPv6EmptyPacketInVxlan">
			<Number name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.PayloadLength"
							size="16" endian="big" value="65535">
				<Relation type="size" of="IPv6Payload" />
			</Number>
			<Number name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.NextHeader" size="8" endian="big" value="60"/>
			<Block name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.IPv6Payload" ref="IPv6:DestinationOptions">
				<Block name="Options">
					<Block ref="IPv6:TLV" name="HomeAddressOption">
						<Number name="Type" size="8" endian="big" value="201"/>
						<Number name="Length" size="8">
							<Relation type="size" of="Value"/>
						</Number>
						<Block name="Value">
							<Blob length="16" value="the other castle"/>
						</Block>
					</Block>
				</Block>
			</Block>
		</Block>
	</DataModel>

	<!-- VXLAN IPv4 Frame + TCP Payload -->
	<DataModel name="IPv4TCPInVxlan">
		<Block name="VXLAN"  ref="IPv4EmptyPacketInVxlan">
			<Number name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.Header.Protocol" size="8" endian="big" value="6"/>
			<Block name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.IPv4Payload" ref="TCP:Packet"/>
		</Block>
	</DataModel>
	
	<!-- VXLAN IPv6 Frame + TCP Payload -->
	<DataModel name="IPv6TCPInVxlan">
		<Block name="VXLAN"  ref="IPv6EmptyPacketInVxlan">
			<Number name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.PayloadLength" 
							size="16" endian="big" value="65535">
				<Relation type="size" of="IPv6Payload" />
			</Number>
			<Number name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.NextHeader" size="8" endian="big" value="6"/>
			<Block name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.IPv6Payload" ref="TCP:Packet"/>
		</Block>
	</DataModel>
	
	<!-- VXLAN IPv4 Frame + UDP Payload -->
	<DataModel name="IPv4UDPInVxlan">
		<Block name="VXLAN"  ref="IPv4EmptyPacketInVxlan">
			<Number name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.Header.Protocol" size="8" endian="big" value="17"/>
			<Block name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.IPv4Payload" ref="UDPv4:Packet"/>
		</Block>
	</DataModel>

	<!-- VXLAN IPv6 Frame + UDP Payload -->
	<DataModel name="IPv6UDPInVxlan">
		<Block name="VXLAN"  ref="IPv6EmptyPacketInVxlan">
			<Number name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.PayloadLength" 
							size="16" endian="big" value="65535">
				<Relation type="size" of="IPv6Payload" />
			</Number>
			<Number name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.NextHeader" size="8" endian="big" value="17"/>
			<Block name="OuterIP.IPv4Payload.UdpPayload.VXHeader.VXLANPayload.InnerIP.IPv6Payload" ref="UDPv4:Packet"/>
		</Block>
	</DataModel>
</Peach>
<!--END-->
