<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://phed.org/2008/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://phed.org/2008/Peach /peach/peach.xsd" author="Mikhail Davidov"
	version="1">


	<!-- Import defaults for Peach instance -->
	<Include ns="default" src="file:defaults.xml"/>

	<PythonPath path="."/>
	<Import from="DCTDecode" import="*"/>
	<Import from="JPGBytePacking" import="*"/>

	<!-- begin EXIF-->


	<DataModel name="TIFFHeader">
		<Choice name="EndianChoice">
			<String name="EndianLittle" value="II" isStatic="true" nullTerminated="false" length="2"
				mutable="false"/>
			<String name="EndianBig" value="MM" isStatic="true" nullTerminated="false" length="2"
				mutable="false"/>
		</Choice>

		<Blob name="Tag" value="2A 00" valueType="hex" isStatic="true" mutable="false"/>

	</DataModel>


	<DataModel name="IFDEntry">
		<Number name="Tag" signed="false" size="16"/>
		<Number name="Type" signed="false" size="16"/>
		<Number name="ComponentCount" signed="false" size="32"/>
		<Blob name="Data" length="4"/>
	</DataModel>

	<DataModel name="IFD">
		<Number size="16" name="DirEntries" signed="false">
			<Relation type="count" of="TheEntry"/>
		</Number>
		<Block name="TheEntry" ref="IFDEntry" minOccurs="1" maxOccurs="3000"/>
	</DataModel>

	<DataModel name="EXIF">
		<Block name="TheTIFFHeader" ref="TIFFHeader"/>
		<Number size="8" signed="false" name="OffsettoFirstIFD">
			<Relation type="offset" of="TheIFD" relative="true" relativeTo="TheTIFFHeader"/>
		</Number>
		<Block name="TheIFD" ref="IFD"/>
	</DataModel>


	<!-- end EXIF-->

	<DataModel name="MarkerSegment">
		<Blob name="Magic" isStatic="true" length="1" value="FF" valueType="hex"/>
		<Blob name="Type" length="1" constraint="value != 0 and value != 255"/>


		<Number endian="big" name="Length" size="16" signed="false">
			<Relation type="size" of="SegmentData" expressionGet="size - 2" expressionSet="size + 2"
			/>
		</Number>


		<Blob name="SegmentData">
			<Relation type="size" from="Length"/>
		</Blob>

	</DataModel>

	<DataModel name="EntropyCodedDataSegment">
		<Blob name="EntropyCodedData" constraint="value > 0">
			<!--Transformer class="BytePacking" /-->
		</Blob>
	</DataModel>



	<DataModel name="FrameHeader" ref="MarkerSegment">
		<Block name="Type">
			<Choice>
				<Blob length="1" valueType="hex" isStatic="true" value="C0"/>
				<Blob length="1" valueType="hex" isStatic="true" value="C1"/>
				<Blob length="1" valueType="hex" isStatic="true" value="C2"/>
				<Blob length="1" valueType="hex" isStatic="true" value="C3"/>

				<Blob length="1" valueType="hex" isStatic="true" value="C5"/>
				<Blob length="1" valueType="hex" isStatic="true" value="C6"/>
				<Blob length="1" valueType="hex" isStatic="true" value="C7"/>

				<Blob length="1" valueType="hex" isStatic="true" value="C9"/>
				<Blob length="1" valueType="hex" isStatic="true" value="CA"/>
				<Blob length="1" valueType="hex" isStatic="true" value="CB"/>

				<Blob length="1" valueType="hex" isStatic="true" value="CD"/>
				<Blob length="1" valueType="hex" isStatic="true" value="CE"/>
				<Blob length="1" valueType="hex" isStatic="true" value="CF"/>
			</Choice>
		</Block>
		<Block name="SegmentData">
			<Relation type="size" from="Length"/>

			<Number endian="big" name="SamplePrecision" size="8" signed="false"/>
			<Number endian="big" name="Y" size="16" signed="false"/>
			<Number endian="big" name="X" size="16" signed="false"/>
			<Number endian="big" name="Nf" size="8" signed="false">
				<Relation type="count" of="ImageComponent"/>
			</Number>

			<Block name="ImageComponent" maxOccurs="255">
				<Relation type="count" from="Nf"/>
				<Number endian="big" name="C" size="8" signed="false"/>
				<Flags name="ImageComponentFlags" size="8">
					<Flag name="H" position="4" size="2"/>
					<Flag name="V" position="0" size="2"/>
				</Flags>
				<Number endian="big" name="Tq" size="8" signed="false"/>
			</Block>

		</Block>
	</DataModel>


	<DataModel name="ScanHeader" ref="MarkerSegment">
		<Blob name="Type" value="DA" length="1" valueType="hex" isStatic="true"/>
		<Block name="SegmentData">
			<Relation type="size" from="Length"/>

			<Number endian="big" name="Ns" size="8" signed="false">
				<Relation type="count" of="ImageComponentFlags1"/>
			</Number>

			<Block name="ImageComponentFlags1" minOccurs="0" maxOccurs="255">
				<Relation type="count" from="Ns"/>

				<Number endian="big" name="Cs" size="8" signed="false"/>

				<Flags name="TheImageComponentFlags1" size="8">
					<Flag name="Td" position="4" size="2"/>
					<Flag name="Ta" position="0" size="2"/>
				</Flags>
			</Block>

			<Number endian="big" name="Ss" size="8" signed="false"/>
			<Number endian="big" name="Se" size="8" signed="false"/>

			<Flags name="ImageComponentFlags2" size="8">
				<Flag name="Ah" position="4" size="4"/>
				<Flag name="Al" position="0" size="4"/>
			</Flags>

		</Block>
	</DataModel>


	<DataModel name="QuantizedTableSpecification" ref="MarkerSegment">
		<Blob name="Type" value="DB" length="1" valueType="hex" isStatic="true"/>
		<Block name="SegmentData">
			<Relation type="size" from="Length"/>

			<Block name="QuanTable" minOccurs="1" maxOccurs="3000">

				<Flags size="8">
					<Flag name="Pq" position="4" size="1"/>
					<Flag name="Tq" position="0" size="2"/>
				</Flags>

				<Blob name="qTable" length="64"/>

			</Block>
		</Block>
	</DataModel>

	<DataModel name="HuffmanTableSpecification" ref="MarkerSegment">
		<Blob name="Type" value="C4" length="1" valueType="hex" isStatic="true"/>
		<Block name="SegmentData">
			<Relation type="size" from="Length"/>

			<Block name="" minOccurs="1" maxOccurs="3000">
				<Flags name="HuffmanTableSpecificationFlags" size="8">
					<Flag name="Tc" position="4" size="1"/>
					<Flag name="Th" position="0" size="2"/>
				</Flags>
				<Block name="TableDefs">
					<Number endian="big" size="8" signed="false" name="T1">
						<Relation type="count" of="V1"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="T2">
						<Relation type="count" of="V2"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="T3">
						<Relation type="count" of="V3"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="T4">
						<Relation type="count" of="V4"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="T5">
						<Relation type="count" of="V5"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="T6">
						<Relation type="count" of="V6"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="T7">
						<Relation type="count" of="V7"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="T8">
						<Relation type="count" of="V8"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="T9">
						<Relation type="count" of="V9"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="T10">
						<Relation type="count" of="V10"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="T11">
						<Relation type="count" of="V11"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="T12">
						<Relation type="count" of="V12"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="T13">
						<Relation type="count" of="V13"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="T14">
						<Relation type="count" of="V14"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="T15">
						<Relation type="count" of="V15"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="T16">
						<Relation type="count" of="V16"/>
					</Number>
				</Block>
				<Block name="TableVals">
					<Number endian="big" size="8" signed="false" name="V1" minOccurs="0"
						maxOccurs="255">
						<Relation type="count" from="T1"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="V2" minOccurs="0"
						maxOccurs="255">
						<Relation type="count" from="T2"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="V3" minOccurs="0"
						maxOccurs="255">
						<Relation type="count" from="T3"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="V4" minOccurs="0"
						maxOccurs="255">
						<Relation type="count" from="T4"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="V5" minOccurs="0"
						maxOccurs="255">
						<Relation type="count" from="T5"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="V6" minOccurs="0"
						maxOccurs="255">
						<Relation type="count" from="T6"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="V7" minOccurs="0"
						maxOccurs="255">
						<Relation type="count" from="T7"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="V8" minOccurs="0"
						maxOccurs="255">
						<Relation type="count" from="T8"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="V9" minOccurs="0"
						maxOccurs="255">
						<Relation type="count" from="T9"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="V10" minOccurs="0"
						maxOccurs="255">
						<Relation type="count" from="T10"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="V11" minOccurs="0"
						maxOccurs="255">
						<Relation type="count" from="T11"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="V12" minOccurs="0"
						maxOccurs="255">
						<Relation type="count" from="T12"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="V13" minOccurs="0"
						maxOccurs="255">
						<Relation type="count" from="T13"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="V14" minOccurs="0"
						maxOccurs="255">
						<Relation type="count" from="T14"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="V15" minOccurs="0"
						maxOccurs="255">
						<Relation type="count" from="T15"/>
					</Number>
					<Number endian="big" size="8" signed="false" name="V16" minOccurs="0"
						maxOccurs="255">
						<Relation type="count" from="T16"/>
					</Number>

				</Block>

			</Block>
		</Block>
	</DataModel>


	<DataModel name="ArithmeticConditioningTableSpecification" ref="MarkerSegment">
		<Blob name="Type" value="CC" length="1" valueType="hex" isStatic="true"/>
		<Block name="SegmentData">
			<Relation type="size" from="Length"/>

			<Block minOccurs="1" maxOccurs="3000">
				<Flags name="ArithmeticConditioningTableSpecificationFlags" size="8">
					<Flag name="Tc" position="4" size="1"/>
					<Flag name="Tb" position="0" size="2"/>
				</Flags>
				<Number endian="big" name="Cs" signed="false" size="8"/>
			</Block>
		</Block>
	</DataModel>

	<DataModel name="RestartIntervalDefinition" ref="MarkerSegment">
		<Blob name="Type" value="DD" length="1" valueType="hex" isStatic="true"/>
		<Block name="SegmentData">
			<Relation type="size" from="Length"/>

			<Number endian="big" name="Ri" signed="false" size="16"/>
		</Block>
	</DataModel>

	<DataModel name="Comment" ref="MarkerSegment">
		<Blob name="Type" value="FE" length="1" valueType="hex" isStatic="true"/>
		<Block name="SegmentData">
			<Relation type="size" from="Length"/>

			<Blob name="CommentBlob"/>
		</Block>
	</DataModel>
	<DataModel name="GenericApplicationData" ref="MarkerSegment">
		<Number endian="big" name="Type" size="8"
			constraint="value &gt;= 224 and value&lt;=239" signed="false"/>
	</DataModel>

	<DataModel name="JFIFFormatData" ref="GenericApplicationData">
		<Number endian="big" name="Type" size="8" value="224" signed="false" isStatic="true"/>
		<Block name="SegmentData">
			<Relation type="size" from="Length"/>

			<Blob name="JFIFIdentifier" isStatic="true" value="4A 46 49 46 00" valueType="hex"/>

			<Blob name="VersionHigh" length="1" value="01" valueType="hex" isStatic="true"/>
			<Blob name="VersionLow" length="1" value="02" valueType="hex"/>

			<Number endian="big" name="Units" size="8" signed="false"/>

			<Number endian="big" name="Xdensity" size="16" signed="false"/>
			<Number endian="big" name="Ydensity" size="16" signed="false"/>


			<Choice name="GridChoice">

				<Block name="Edge">
					<Number endian="big" name="Xthumbnail" size="8" signed="false">
						<Relation type="count" of="xScan"/>
					</Number>
					<Number endian="big" name="Ythumbnail" size="8" signed="false" isStatic="true"
						value="0"/>

					<Block name="xScan" minOccurs="0" maxOccurs="255">
						<Relation type="count" from="Xthumbnail"/>
						<Blob name="RGB" length="3"/>
					</Block>
				</Block>

				<Block name="Normal">
					<Number endian="big" name="Xthumbnail" size="8" signed="false">
						<Relation type="count" of="xScan"/>
					</Number>
					<Number endian="big" name="Ythumbnail" size="8" signed="false">
						<Relation type="count" of="yScan"/>
					</Number>

					<Block name="yScan" minOccurs="0" maxOccurs="255">
						<Relation type="count" from="Ythumbnail"/>
						<Block name="xScan" minOccurs="0" maxOccurs="255">
							<Relation type="count" from="Xthumbnail"/>
							<Blob name="RGB" length="3"/>
						</Block>
					</Block>

				</Block>

			</Choice>

		</Block>


	</DataModel>

	<DataModel name="JFIFExtension" ref="GenericApplicationData">
		<Number endian="big" name="Type" size="8" value="224" signed="false" isStatic="true"/>
		<Blob name="JFXXIdentifier" isStatic="true" value="4A 46 58 58 00" valueType="hex"/>

		<Number endian="big" name="ExtensionCode" size="8" signed="false"/>
		<Blob name="ExtensionData"/>
	</DataModel>

	<DataModel name="ApplicationData">
		<Choice>
			<Block name="TheJFIFFormatData" ref="JFIFFormatData"/>
			<Block name="TheJFIFExtension" ref="JFIFExtension"/>
			<Block name="TheGenericApplicationData" ref="GenericApplicationData"/>
		</Choice>
	</DataModel>

	<DataModel name="JPEGData" ref="MarkerSegment">
		<Number endian="big" name="Type" constraint="value &gt;= 240 and value&lt;=253"
			size="8"/>
	</DataModel>


	<DataModel name="DefineNumberofLines" ref="MarkerSegment">
		<Blob name="Type" value="DC" length="1" valueType="hex" isStatic="true"/>
		<Block name="SegmentData">
			<Relation type="size" from="Length"/>

			<Number endian="big" name="NL" size="16" signed="false"/>
		</Block>
	</DataModel>



	<DataModel name="TablesMisc">
		<Choice minOccurs="0" maxOccurs="3000">
			<Block name="TheApplicationData" ref="ApplicationData"/>
			<Block name="TheQuantizedTableSpecification" ref="QuantizedTableSpecification"/>
			<Block name="TheHuffmanTableSpecification" ref="HuffmanTableSpecification"/>
			<Block name="TheArithmeticConditioningTableSpecification"
				ref="ArithmeticConditioningTableSpecification"/>
			<Block name="TheRestartIntervalDefinition" ref="RestartIntervalDefinition"/>
			<Block name="TheComment" ref="Comment"/>
		</Choice>
	</DataModel>



	<DataModel name="DefineHierarchicalProgression" ref="FrameHeader">
		<Blob name="Type" value="DE" length="1" valueType="hex" isStatic="true"/>
	</DataModel>

	<DataModel name="ExpandSegment" ref="MarkerSegment">
		<Blob name="Type" value="DF" length="1" valueType="hex" isStatic="true"/>
		<Block name="SegmentData">
			<Relation type="size" from="Length"/>

			<Flags name="ExpandSegmentFlags" size="8">
				<Flag name="Eh" position="4" size="1"/>
				<Flag name="Ev" position="0" size="1"/>
			</Flags>
		</Block>
	</DataModel>

	<DataModel name="Frame">

		<Block name="TheTablesMisc" ref="TablesMisc"/>
		<Block name="TheFrameHeader" ref="FrameHeader"/>

		<Block name="Scan" minOccurs="1" maxOccurs="3000">
			<Block name="ScanTablesMisc" ref="TablesMisc"/>
			<Block name="TheScanHeader" ref="ScanHeader"/>
			<Block name="TheEntropyCodedDataSegment" ref="EntropyCodedDataSegment"/>
		</Block>
	</DataModel>


	<DataModel name="HierarchicalMode">
		<Block name="DHP" ref="DefineHierarchicalProgression"/>
		<Block name="aFrame" ref="Frame" minOccurs="1" maxOccurs="3000">
			<Block name="FrameHeader">
				<Block name="EXP" ref="ExpandSegment" minOccurs="0" maxOccurs="1"/>
				<Block name="ActualHeader" ref="FrameHeader"/>
			</Block>
		</Block>
	</DataModel>

	<DataModel name="JPG-JFIF">
		<Blob name="SOIMagic" value="FF D8" valueType="hex" isStatic="true" mutable="false"/>
		<Choice>
			<Block name="TheFrame" ref="Frame"/>
			<Block name="TheHierarchicalMode" ref="HierarchicalMode"/>
		</Choice>
		<Blob name="EOIMagic" value="FF D9" valueType="hex" isStatic="true" mutable="false"/>
	</DataModel>


	<StateModel name="TheState" initialState="Initial">
		<State name="Initial">
			<Action type="output">
				<DataModel ref="JPG-JFIF"/>
				<!-- This will load files from samples every 5000 iterations -->
				<Data name="data" fileName="samples" switchCount="5000"/>
			</Action>

			<Action type="close"/>
			
			<Action type="call" method="ScoobySnacks"/>
		</State>
	</StateModel>

	<Agent name="LocalAgent">
		<Monitor class="debugger.WindowsDebugEngine">
			<Param name="CommandLine"
				value="&quot;C:\Program Files (x86)\Adobe\Acrobat 9.0\Acrobat\Acrobat.exe&quot; fuzzed.pdf"/>
			<Param name="StartOnCall" value="ScoobySnacks"/>
		</Monitor>
		<Monitor class="process.PageHeap">
			<Param name="Executable" value="Acrobat.exe"/>
		</Monitor>
	</Agent>

	<Test name="TheTest">
		<Agent ref="LocalAgent"/>
		<StateModel ref="TheState"/>

		<Publisher class="DCTDecodePublisher">
			<Param name="fileName" value="fuzzed.jpg"/>
			<Param name="Window" value="Acrobat"/>
			<Param name="debugger" value="true"/>
		</Publisher>
	</Test>

	<Run name="DefaultRun">
		<Test ref="TheTest"/>

		<Logger class="logger.Filesystem">
			<Param name="path" value="logs"/>
		</Logger>
	</Run>
</Peach>
