<<<
[[Flag]]
== Flag

// Reviewed:
//  - 03/06/2014: Lynn
//   Added child elements and corrected spelling in other comments

The Flag element defines a specific bit field in a Flags container.

See also parent element xref:Flags[Flags].

=== Syntax

[source,xml]
----
<Flags name="options" size="16">
  <Flag name="compression" position="0" size="1" />
  <Flag name="compressionType" position="1" size="3" />
  <Flag name="opcode" position="10" size="2" value="5" />
</Flags>
----

=== Attributes

_Required:_

xref:size[size]:: Size in bits
xref:position[position]:: Position (zero based) flag starts

_Optional:_

xref:name[name]:: Name of the element
xref:value[value]:: The default value contained within the element
xref:valueType[valueType]:: The format in which the default value is expressed. (i.e hex, string, or literal)
xref:token[token]:: Is data element a token? Default is false.
xref:mutable[mutable]:: Is data element changeable (should it be mutated), defaults to true

=== Child Elements

xref:Analyzers[Analyzer]:: Analyze current element post cracking, can dynamically change model.
xref:Fixup[Fixup]:: Dynamic transformations such as checksums and CRCs.
xref:Hint[Hint]:: Provide information to mutators.
xref:Placement[Placement]:: Relocate an element after it has been cracked.
xref:Relation[Relation]:: Modeling of relationships in the data (such as comparisons)
xref:Transformer[Transformer]:: Static transformations such as compression or encoding.

=== Mutators

The following mutators will operate on this element type:

xref:Mutators_DataElementDuplicateMutator[DataElementDuplicateMutator]:: Duplicates a node's value from 2x - 50x
xref:Mutators_DataElementRemoveMutator[DataElementRemoveMutator]:: Removes nodes from the data model
xref:Mutators_DataElementSwapNearNodesMutator[DataElementSwapNearNodesMutator]:: Swaps two nodes in the data model that are neighbouring each other

xref:Mutators_FiniteRandomNumbersMutator[FiniteRandomNumberMutator]::
	This mutator produces "random" numbers using a static seed so it will always produce the same random numbers.
	By default 5,000 numbers are produced for each Number element that is found.

xref:Mutators_NumericalEdgeCaseMutator[NumericalEdgeCaseMutator]::
	This mutator will produce values in a range of N - 50 through N + 50 for all numerical edge cases.
	For example 16-bit numbers have the following edge cases: 0, signed byte (127), unsigned byte (255), signed short, unsigned short.

xref:Mutators_NumericalVarianceMutator[NumericalVarianceMutator]::
	This mutator will produce values of default - N through default + N where N defaults to 50 but is controllable via a hint.
	For example, if the default value of a Number field is 200, by default this mutator will produce all the values between 150 and 250.

xref:Mutators_ValidValuesMutator[ValidValuesMutator]::
	This mutator will allow users to specify additional data for each data element through a hint.
	Each of these values must be separated with a semicolon.

xref:Mutators_WordListMutator[WordListMutator]::
	This mutator will allow users to specify additional data for each data element through a hint.
	Each of these values must be separated by a newline in a file.

=== Examples

.Example of Flags
=================================

This example shows a real world example of a flag set by modeling a TCP packet (without options). This example also shows using relations with the xref:Flag[Flag] element.

[source,xml]
----
<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://peachfuzzer.com/2012/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
			 xsi:schemaLocation="http://peachfuzzer.com/2012/Peach peach.xsd">

	<DataModel name="TcpPacket">
		<Block name="Header">
			<Number name="SrcPort" size="16" endian="big" value="1234"/>
			<Number name="DestPort" size="16" endian="big" value="1234"/>
			<Number name="SequenceNumber" size="32" endian="big" valueType="hex" value="0043a577"/>
			<Number name="AcknowledgmentNumber" size="32" endian="big" value="0"/>

			<Flags name="ControlBits" size="16" endian="big">
				<Flag name="Offset" position="0" size="4" valueType="hex">
					<Relation type="size" of="Header" expressionGet="size * 4" expressionSet="size / 4"/>
				</Flag>
				<Flag name="Reserved" position="4" size="3"/>
				<Flag name="NS" position="7" size="1"/>
				<Flag name="CWR" position="8" size="1"/>
				<Flag name="ECE" position="9" size="1"/>
				<Flag name="URG" position="10" size="1"/>
				<Flag name="ACK" position="11" size="1"/>
				<Flag name="PSH" position="12" size="1"/>
				<Flag name="RST" position="13" size="1"/>
				<Flag name="SYN" position="14" size="1"/>
				<Flag name="FIN" position="15" size="1"/>
			</Flags>

			<Number name="WindowSize" size="16" endian="big" valueType="hex" value="aaaa"/>
			<Number name="CheckSum" size="16" endian="big">
				<Fixup class="TCPChecksumFixup">
					<Param name="ref" value="TcpPacket" />
					<Param name="src" value="127.0.0.1" />
					<Param name="dst" value="127.0.0.1" />
				</Fixup>
			</Number>
			<Number name="UrgentPointer" size="16" endian="big"/>
		</Block>

		<Blob name="TcpPayload" value="this is a packet.\n"/>
	</DataModel>

	<StateModel name="TheStateModel" initialState="InitialState">
		<State name="InitialState">
			<Action type="output">
				<DataModel ref="TcpPacket" />
			</Action>
		</State>
	</StateModel>

	<Test name="Default">
		<StateModel ref="TheStateModel" />

		<Publisher class="ConsoleHex"/>

		<Logger class="File">
      <Param name="Path" value="logs"/>
    </Logger>
	</Test>
</Peach>
----

Produces the following output:

----
> peach -1 --debug example.xml

[[ Peach Pro v3.0.0
[[ Copyright (c) Deja vu Security

[*] Test 'Default' starting with random seed 17543.

[R1,-,-] Performing iteration
Peach.Core.Engine runTest: Performing recording iteration.
Peach.Core.Dom.Action Run: Adding action to controlRecordingActionsExecuted
Peach.Core.Dom.Action ActionType.Output
Peach.Core.Publishers.ConsolePublisher start()
Peach.Core.Publishers.ConsolePublisher open()
Peach.Core.Publishers.ConsolePublisher output(38 bytes)
00000000   04 D2 04 D2 00 43 A5 77  00 00 00 00 50 00 AA AA   ?????C?w????P???
00000010   1D F6 00 00 74 68 69 73  20 69 73 20 61 20 70 61   ????this is a pa
00000020   63 6B 65 74 2E 0A                                  cket.?
Peach.Core.Publishers.ConsolePublisher close()
Peach.Core.Engine runTest: context.config.singleIteration == true
Peach.Core.Publishers.ConsolePublisher stop()

[*] Test 'Default' finished.
----

=================================
