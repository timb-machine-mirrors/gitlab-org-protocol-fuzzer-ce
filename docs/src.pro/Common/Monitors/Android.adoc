<<<
[[Monitors_Android]]
== Android Monitor

*Monitor Categories*: *Automation*, *Fault detection*

The _Android_ monitor examines both targeted Android applications and the state of the
Android OS. Peach supports Andorid OS verions 4.0 to 5.1, inclusively.

Two expected use cases are:

* Maintaining state while fuzzing native code
* Launching and monitoring Android Java applications.

The _Android_ monitor can start or restart the device at the following times:

* The start of a fuzzing run
* The start of each test iteration
* The start of an iteration that immediately follows a fault
* When called from the state model

The Android monitor watches the message logs and the device, and can generate faults for the following conditions:

* A logging message matches the fault search criteria, Peach logs a fault.
* A logging message matches the fault search criteria, Peach logs a fault and stops fuzzing.
* A physical device becomes nonresponsive.
* A virtual device beocmes nonresponsive or lost.

After detecting a fault, this monitor collects data from the device log files and crash dumps.

Additionally, the monitor logs exceptions, and updates fault bucket information. For bucketing,
Peach uses the text from the fault to determine the major bucket level. The minor bucket level
is not used. The risk evaluation looks for error, fatal error, or unknown.

The _Android_ monitor uses the Android Debugging Bridge (adb) to communicate with a device. This
monitor can target both emulated and physical devices. The _Android_ monitor requires
http://developer.android.com/sdk/index.html[Android Platform Tools] and either an emulator or a
physical Android device. The configuration for a physical device follows. For a configuration using
a virtual device, see the xref:Monitors_AndroidEmulator[Android Emulator Monitor].

image::{images}/AndroidMtr.png["Fuzzing Configuration for Andtroid Device", scalewidth="75%"]

[NOTE]
======================
Connecting to a physical device requires the device serial number. You can obtain this from a
connected device by using the following adb command: "adb{nbsp}devices". The result is a list of
devices that adb found. The information for each device consists of two parts: the device
number and the connection status between adb and the device. The list includes physical and
virtual devices.

For more information about debugging Android devices, see the following:

* http://developer.android.com/tools/help/adb.html[Android Debug Bridge].
* http://www.howtogeek.com/125769/how-to-install-and-use-abd-the-android-debug-bridge-utility/[How To Install and Use ADB, the Android Debug Bridge Utility]

======================

=== Parameters

_Required:_

ApplicationName:: Name of the Android application.

_Optional:_

ActivityName:: Name of the application activity, defaults to "".
AdbPath:: Directory path to adb, defaults to "".
ClearAppData:: Removes the application data and cache every iteration, defaults to false.
ClearAppDataOnFault:: Removes the application data and cache on faulting iterations, defaults to false.
CommandTimeout:: Sets the maximum number of seconds to wait for the adb command to complete, defaults to 10 seconds.
ConnectTimeout:: Sets the maximum number of seconds to wait to establish an adb connection, defaults to 5 seconds.
DeviceMonitor:: Identifies the Android monitor that supplies the device serial number, defaults to "". Used when monitoring a virtual device.
DeviceSerial:: The serial number of the device to monitor, defaults to "". Used when monitoring a physical device.
FaultRegex:: Specifies a regex; when matched from a log entry, triggers a fault. The default regeex
is '(\^E/ActivityMonitor)|(^E/AndroidRuntime)|(^F/.*)'.
FaultWaitTime:: Sets the time period, in milliseconds, to wait when checking for a fault, defaults to 0 ms.
IgnoreRegex:: Specifies a regex; when matched, the monitor ignores potential false positive faults, defaults to "".
MustStopRegex:: Specifies a regex; when a match occurs, the monitor triggers a fault and stops fuzzing, defaults to "".
ReadyTimeout:: Sets the maximum number of seconds to wait for the device to reach readiness--able to respond to inputs, defaults to 600 seconds.
RebootEveryN:: Specifies the number of iterations between successive device reboots, defaults to 0.
RebootOnFault:: Reboots the device when a fault occurs, defaults to false.
RestartEveryIteration:: Restarts the application every iteration, defaults to false.
StartOnCall:: Starts the application when notified by the state machine. The string value used here must match the Call Action statement of the state model. The default string is "".
WaitForReadyOnCall:: Waits for the device to be ready when notified by the state machine. The string used here must match the corresponding Call Action statement of the state model. the default string is "".

TIP: The DeviceMonitor and the DeviceSerial parameters are mutually exclusive. Use DeviceSerial to provide the serial number of a physical device. Use DeviceMonitor when using the Android Emulator, as the Emulator will provide the serial number of the virtual device.

=== Examples

ifdef::peachug[]

.Basic Usage with a Physical Device  +
====================

This parameter example is from a setup that the BadBehaviorActivity, sending random taps to generate different types of exceptions and crashes. The setup is for a physical Android device.

+Android Monitor (App) Parameters+
[cols="2,4" options="header",halign="center"]
|==========================================================
|Parameter        |Value
|ApplicationName  |com.android.development
|ActivityName     |.BadBehaviorActivity
|AdbPath          |C:\adt-bundle-windows-x86_64-20131030\sdk\platform-tools
|DeviceSerial     |emulator-5554
|==========================================================

====================


.Basic Usage with a Virtual Device +
====================

This parameter example is from a setup that the BadBehaviorActivity, sending random taps to generate different types of exceptions and crashes. The setup is for a virtual Android device, and uses the Android monitor, as well as the Andtroid Emulator monitor.

If you want to run the Android emulator, set your AdbPath to the directory containing the adb (Android Debug Bridge)
platform-tools directory and point the EmulatorPath in the Android Emulator Monitor to the adb tools directory.

The Avd parameter in the Android Emulator Monitor must also be the name of a valid AVD (Android Virtual Device).
Use the following steps to create a new AVD:

. Open the 'android.bat' file located in the adb SDK tools directory.
. From the GUI that opens, click on 'Tools' in the menu bar, then 'Manage AVDs...'.
. From the window that opens, click 'New...' and create a new AVD.

_Android Emulator (Emu) Monitor Parameters_
[cols="2,4" options="header",halign="center"]
|==========================================================
|Parameter        |Value
|Avd              |Nexus4
|EmulatorPath     |C:\adt-bundle-windows-x86_64-20131030\sdk\tools
|==========================================================

_Android Monitor (App) Parameters_
[cols="2,4" options="header",halign="center"]
|==========================================================
|Parameter        |Value
|ApplicationName  |com.android.development
|ActivityName     |.BadBehaviorActivity
|AdbPath          |C:\adt-bundle-windows-x86_64-20131030\sdk\platform-tools
|DeviceMonitor    |Emu
|==========================================================

====================


endif::peachug[]


ifndef::peachug[]


.Basic Usage Example +
======================
This example runs the BadBehaviorActivity, sending random taps to generate different types of exceptions and crashes.

To run the Android emulator, set your AdbPath to the directory containing the adb (Android Debug Bridge) platform-tools directory and point the EmulatorPath to the adb tools directory.

The Avd parameter must also be the name of a valid AVD (Android Virtual Device). To create a new AVD:

. Open the 'android.bat' file located in the adb SDK tools directory.
. From the GUI that opens, click on 'Tools' in the menu bar, then 'Manage AVDs...'.
. From the window that opens, click 'New...' and create a new AVD.

[source,xml]
----
<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://peachfuzzer.com/2012/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://peachfuzzer.com/2012/Peach peach.xsd">

	<DataModel name="TheDataModel">
		<Number size='32' signed="false" value="31337" />
	</DataModel>

	<DataModel name="X">
		<Number size='32' signed="false" value="100" />
	</DataModel>

	<DataModel name="Y">
		<Number size='32' signed="false" value="0" />
	</DataModel>

	<StateModel name="State" initialState="Initial" >
		<State name="Initial"  >
			<Action type="call" method="tap">
				<Param>
					<DataModel ref="X"/>
				</Param>
				<Param>
					<DataModel ref="Y"/>
				</Param>
			</Action>
		</State>
	</StateModel>

	<Agent name="TheAgent">
		<Monitor name="Emu" class="AndroidEmulator">
			<Param name="Avd" value="Nexus4" />
			<Param name="EmulatorPath" value="C:\adt-bundle-windows-x86_64-20131030\sdk\tools"/>
		</Monitor>

		<Monitor name="App" class="Android">
			<Param name="ApplicationName" value="com.android.development" />
			<Param name="ActivityName" value=".BadBehaviorActivity" />
			<Param name="AdbPath" value="C:\adt-bundle-windows-x86_64-20131030\sdk\platform-tools"/>
			<Param name="DeviceMonitor" value="Emu" />
		</Monitor>
	</Agent>

	<Test name="Default">
		<StateModel ref="State"/>
		<Agent ref="TheAgent" />

		<Publisher class="AndroidMonkey">
			<Param name="DeviceMonitor" value="App"/>
		</Publisher>

		<Logger class="File">
			<Param name="Path" value="logs"/>
		</Logger>
	</Test>
</Peach>
----

Output for this example.

----
>peach -1 --debug example.xml

[[ Peach Pro v3.0.0.0
[[ Copyright (c) Peach Fuzzer LLC

[*] Test 'Default' starting with random seed 3054.
Peach.Core.Agent.Agent StartMonitor: Emu AndroidEmulator
Peach.Core.Agent.Agent StartMonitor: App Android
Peach.Core.Agent.Agent SessionStarting: Emu
Peach.Enterprise.Agent.Monitors.AndroidEmulator Starting android emulator
Peach.Enterprise.Agent.Monitors.AndroidEmulator Resolved emulator instance to android device 'emulator-5554'
Peach.Enterprise.Agent.Monitors.AndroidEmulator Android emulator 'emulator-5554' successfully started
Peach.Core.Agent.Agent SessionStarting: App
Peach.Enterprise.AndroidBridge Initializing android debug bridge.
Peach.Enterprise.AndroidBridge Android debug bridge initialized.
Peach.Enterprise.Agent.Monitors.AndroidMonitor Resolved device 'emulator-5554' from monitor 'Emu'.
Peach.Enterprise.AndroidDevice Waiting for device 'emulator-5554' to become ready
Peach.Enterprise.AndroidDevice Device 'emulator-5554' is now ready
Peach.Enterprise.AndroidDevice Executing command on 'emulator-5554': am start -W -S -n com.android.development/.BadBehaviorActivity

[R1,-,-] Performing iteration
Peach.Core.Engine runTest: Performing recording iteration.
Peach.Core.Dom.Action Run: Adding action to controlRecordingActionsExecuted
Peach.Core.Dom.Action ActionType.Call
Peach.Enterprise.Publishers.AndroidMonkeyPublisher start()
Peach.Enterprise.Publishers.AndroidMonkeyPublisher call(tap, System.Collections.Generic.List`1[Peach.Core.Dom.ActionParameter])
Peach.Core.Agent.AgentManager Message: App => DeviceSerial
Peach.Enterprise.Publishers.AndroidMonkeyPublisher Resolved device 'emulator-5554' from monitor 'App'.
Peach.Enterprise.AndroidDevice Executing command on 'emulator-5554': input tap 100 0
Peach.Core.Engine runTest: context.config.singleIteration == true
Peach.Enterprise.Publishers.AndroidMonkeyPublisher stop()
Peach.Core.Agent.Agent SessionFinished: App
Peach.Enterprise.AndroidBridge Terminating android debug bridge.
Peach.Core.Agent.Agent SessionFinished: Emu
Peach.Enterprise.Agent.Monitors.AndroidEmulator Sending stop command to emulator 'emulator-5554'
Peach.Enterprise.Agent.Monitors.AndroidEmulator Waiting for emulator 'emulator-5554' to exit
Peach.Enterprise.Agent.Monitors.AndroidEmulator Emulator 'emulator-5554' exited with code: 0
Peach.Enterprise.Agent.Monitors.AndroidEmulator Emulator 'emulator-5554' exited

[*] Test 'Default' finished.
----
======================

endif::peachug[]
