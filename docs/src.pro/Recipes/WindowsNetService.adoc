:images: ../images
:peachweb: Peach Web Interface
:peachcomd: Peach Command Line Interface
:peachug: Peach User Guide

[[Recipe_WindowsNetServer]]

=== Recipe: Monitoring a Windows Network Service

image::{images}/winlogo.jpg["Windows logo", scale="40"]

This recipe describes the base setup needed to fuzz a Windows network service. The recipe is a model that you can follow exactly as is. Or, you can use the model as 
a starting point and augment the model for your specific situation. This recipe 
consists of the following parts: 

1.	The workflow for the fuzzing session
2.	The Peach monitoring and agent components to use in configuring the fuzzing setup
3.	Configuration settings used to fuzz a sample service (SNMP) running this workflow

IMPORTANT: Assumptions/Givens in this recipe are that a Pit is ready to use; Peach is ready to run; and any software module needed to perform the fuzzing job is installed.

In this scenario, Peach runs on a host computer; the network server runs in a 
Virtual Machine (VM) on the host. With Peach running on the host, it controls the 
environment. If the netowrk server crashes, the worst thing that happens is that 
the virtual machine has to restart. Peach recover the data if the network 
server crashes. 

==== Workflow for the Fuzzing Session

The workflow lists the task sequence that occurs when running the fuzzing session. 
The setup needed to implement the workflow follows in the next section. Start with 
defining the workflow, especially if you plan to embellish the recipe.

Here is the workflow that Peach performs in fuzzing a Windows network service:

1. Revert to a virtual machine snapshot.
2. Wait for the machine to boot up.
3. Launch the network service.
4. Perform fuzzing. Create and run test cases.

* Peach initiates contact with the server and sends packets of fuzzed data to the server.
* Check for faults, such as crashes and access violations.

5. When a fault occurs, do the following:

..	Collect data surrounding the test case.
..	Revert to the VM snapshot.
..	Launch the network service.

6.	Loop to step 4 (resume fuzzing).


==== Peach Components Needed in the Fuzzing Configuration 

Defining the Peach components divides in two parts: identifying the monitors to use in the configuration and identifying where to locate the specified monitors. 

===== Identifying Monitors

This part of the recipe revisits each step of the workflow to identify the monitors needed to implement the configuration:

1. Revert to a snapshot of a virtual machine. 
+
Peach needs to automate the test environment and remove human interaction during the fuzzing job. We place the service in a virtual machine (VM) because Peach can use a VM monitor to automatically start and reset the test environment when needed. 
+
The VM snapshot is taken while the guest OS and the Peach agent are running. Using such a snapshot avoids the wait time associated with booting up the virtual machine. Also, the same snapshot is used when Peach refreshes the test environment after a fault occurs. 
+
The monitor for the VM environment, xref:Monitors_Vmware[VMware] monitor, resides on the host machine.

2. Wait for the machine to boot up.
+
Peach waits for the VM snapshot to resume.

3. Launch the network service. 
+
In Windows, Peach needs to explicitly launch the network service when Pageheap and the Windows debugger are used. The xref:Monitors_WindowsService[WindowsService] monitor manages the service on the remote machine with the test target.

4. Perform fuzzing, checking for faults.
+
Perform fault detection in the VM. The xref:Monitors_WindowsDebugger[WindowsDebugger] monitor watches the internals of the services and detects faults such as access violations and exceptions. 
+
The xref:Monitors_PageHeap[PageHeap] monitor complements the Windows debugger by enabling heap analysis in the debugger. 
+
Both monitors run on the remote machine as the test target.

5. Collect data surrounding each fault as it happens.
+
Peach sends and receives network packets to the service. When a fault occurs, the packets involved with the fault are interesting. Peach captures the packets using the xref:Monitors_Pcap[NetworkCapture] monitor. This monitor resides on the local machine with Peach Fuzzer.


6. Resume fuzzing.
+
This step uses the VM monitor and VM snapshot from step 1 to refresh the test environment, and the WindowsService monitor from step 3 to start the network service in the refreshed environment. No additional monitors are needed for this step. 

===== Identifying Agents

Peach offers two types of agents to manage monitors and I/O publishers: local and remote.

* Local agents reside inside Peach. +
The local agent in this recipe addresses automation involving the VM and data collection 
that captures network packets. The local agent houses the xref:Monitors_Vmware[VMware] 
 and the xref:Monitors_Pcap[NetworkCapture] monitors. 
+
The VMware monitor starts a snapshot VM environment at the beginning of the fuzzing job, 
as well as restarting the same VM snapshot after a fault occurs. 

* Remote agents reside in separate processes on remote machines with the test targets. +
In this case, the remote agent and the Linux service reside on the same machine. 
+
The remote agent houses the xref:Monitors_Gdb[Gdb] debug monitor that starts the 
network service at the beginning of the fuzzing job and restarts the service in the 
refreshed environment after a fault. The WindowsDebug monitor detects faults that occur in 
the service. 

The result is that we end up with the following configuration:

image::{images}/LinuxNetworkService.png["Configuration for Windows Service with VM", scale="50"]

Peach is located on one machine with a local agent that houses the VM monitor and the Network capture monitor. A second agent resides on the remote machine with the service. The remote agent houses the PageHeap, the WindowsDebugger, and the WindowsService monitors. 

The local agent is simple to implement. All that’s needed is to define the agent, then specify the appropriate monitors and monitor settings used with the local agent. 

The remote monitor is a little more involved. Like the local agent, the remote agent needs to be defined, then specify the appropriate monitors and monitor settings used with the remote agent. Second, the remote agent needs to run on the same OS as the test target. This step can be done separately from specifying the configuration details. In this recipe, a VM snapshot is used. See the section, Using Virtual Machines, for information on setting up the VM snapshot.

==== Sample configuration Using SNMP 

This section shows the recipe implemented for the SNMP network service and consists of the following items:

* Settings for the SNMPD service on the Windows VM 
* Setting a static IPv4 address on the Windows VM 
* Pit variables 
* Peach agents
* Peach monitors

===== SNMPD Service Setup 

WindowsXP and later versions include an SNMP service as part of the operating system; however, the service is inactive by default. The sample configuration uses this SNMP service as the fuzzing target. You can activate the SNMP service in Windows with the following steps:

1. Navigate to the IPv4 Settings using the following menu entries: +
Control Panel -> Programs 
2. In the “Programs and Features” group, find the entry titled “Simple Network Management Protocol (SNMP).
3. Check the box to the left of the SNMP entry and click OK. 

Use the following steps to ensure the SNMP service is ready for use:

1. From the Windows Start button, right-click “Computer”, then select “Manage” from the shortcut menu.
2. Expand the “Services and Applications” entry in the Computer Management pane.
3. Double-click “Services”.
4. Search for the SNMP Service. The following illustration shows the entry with highlighting.
+
image::{images}/WindowsComputerMgmt.png["Windows SNMP Service Entry", scale="50"]
5. If the status is not “Stopped”, right-click the service name and choose “Stop”.

A few properties of the SNMP service need to be configured to use the service. Right click on the Servcice entry (shown in the previous illustration) and adjust the following settings in the SNMP Properties dialog:

* Traps Tab: +
Add “public” as a community name.
* Security Tab: 
** Add “READ/WRITE” permissions to the “public” community. 
** Choose the radio button “Accept SNMP packets from any host”. +
Then, click OK to save the changes.

NOTE: Properties in the following tabs require no changes: General, Log On, Recovery, Agent, and Dependencies.


====== Setting a Static IPv4 address in the Windows VM

If you are automating fuzzing sessions for the configuration, ensure the IPv4 address on the target system is static so that each time the operating system starts or reverts to the snapshot, Peach can use the same address.

1.	Navigate to the IPv4 Settings using the following menu entries: 
+
Control Panel -> Netowrk and Internet -> Network Connections
2.	Select the appropriate network adapter. 
3.	Right-click and select Properties from the shortcut menu.
4.	Select the Internet Protocol Version 4 (IPv4) entry and click “Properties”.
+
The following properties dialogs for the IP v4 protocol display the settings for a dynamic IP assignment on the left. The example static values are displayed on the right. Use values for one of the interfaces on your system. You can run the “ipconfig –all” command in a command processor to obtain the details for your system.
+
image::{images}/IPv4_Chg_to_Static.png["Spicifying a static IPv4 address", scale="50"]
+
Click “Use the following IP address”, and fill in the values for the IP address and submask.
5.	When finished, click OK.

===== Pit Variables 

The following UI display identifies data values needed by the Pit, regardless of the monitors used in the configuration. The screen is modified slightly to focus solely on the Pit-specifc variables.

image::{images}/Recipe_WinSrvc_SNMP_Vars.png["Pit-specific Variabls for Windows Service with VM", scale="50"]

The Pit User Guides describe the Pit-specific variables. In this sample, the SNMP Peach Pit User Guide provides the following descriptions. _Annotations for the variables are italicized_:

SNMP Community String:: Community string used for authentication by the SNMP server. The default value is public. The target SNMP server must be configured to respond to this community string.
+
_Check the SNMP server documentation for consistency of this value. If needed, change the value here to coincide with the value expected by the test target._

Source Port:: Port number of the local machine that sends packets to the server. The default value is 162. 
+
_Port 162 is a well-known port value and can be left as is._

Target IPv4 Address:: IPv4 address of the target machine (server). The default value is 127.0.0.1. For information on obtaining the IP v4 address, see Retrieving Machine Information.
+
_Use the IPv4 address reported by ifconfig for one of the interfaces in the VM, such as Local Area Connection. For more information, see the Retrieving Machine Information section of the *SNMP Peach Pit User Guide*._

Target Port:: SNMP port number of the server that receives packets. The default value is 161.
+
_Port 161 is a well-known port value and can be left as is._

Timeout:: Duration, in milliseconds, to wait for incoming data. A value of `-1` extends the duration to infinity. The default value is 1000 ms. During fuzzing, a timeout failure causes the fuzzer to skip to the next test case.
+
_Use the default value, as it is sufficient for most implementations._

===== Agents 

The following UI diagram acts as an overview, showing the Peach agents and the monitors within each agent. Peach uses the ordering within the agent to determine the order in which to load and run monitors.

image::{images}/Recipe_WinSvc_Agents_N_Mons.png["Agents and Monitors for Windows Service with VM", scale="50"]

The local agent is defined first and lists the default information for both name and location. This definition for a local agent is typical and, otherwise, unremarkable. The monitor list includes the NetworkCapture and the Vmware monitors that are independent of each other. 

The remote agent, named "Remote", has quite a different location specification. The location consists of concatenated pieces of information:

* Channel. The channel for a remote agent is `tcp`. A colon and two forward slashes separate the channel from the IP v4 address of the hardware interface. 
* IP v4 address. The IP v4 address of the agent is the second component of the location. Use `ipconfig -all` to  find this address of the remote machine.

The monitor list within each agent is significant, as the monitors launch in sequence from top to bottom within an agent.

NOTE: For first-time users, we recommend that you build incrementally to the final recipe configuration by testing each monitor along the way. You can run the VM manually until you're ready to automate the environment.

1.	Start with the local agent and the network capture monitor to capture network packets. 
2.	Add the remote agent and the WindowsService monitor.
3.	Add the WindowsDebugger monitor to the remote agent. 
4.	Add the PageHeap monitor to the remote agent and reposition it atop the remote agent monitor list.
5.	Add automation to the local agent using the Vmware monitor. 

===== Monitors 

This recipe uses five monitors, two on the machine with Peach and three on the remote machine. The recipe shows each monitor and describes its roles (fault detection, data collection, and automation), applicable operating systems, and the most important data fields. 

TIP: The important monitor parameters are identified using the stylized Peach logo adjacent to the entry.

TIP: When specifying a backslash (\) in the Peach Web user interface, double them, as the parser treats the first \ as a meta character. 

====== NetworkCapture Monitor

The xref:Monitors_Pcap[Netowrk Capture Monitor (InterestingPackets)] monitor captures network packets when a fault occurs and stores them in the log for the test case that generates the fault. The monitor uses the settings in the following illustration:
 
image::{images}/Recipe_WindowsSvc_NetCapture_Mon.png["NetworkCapture Monitor", scale="50"]

The most signification parameters for the network capture monitor follow:

Device:: Name of the interface on the local machine (the machine with Peach) used to communicate with the test target. Use `ipconfig –all` to identify the interface(s) available for use.

Filter:: The packet filter helps capture only those packets associated with the fuzzing session. The filter adheres to the syntax and requirements of the Pcap filter specification.

[NOTE]
=======
You can find the appropriate host interface that communicates with the VM using the following steps:

1. Collect a list of interfaces (and their IPv4 addresses) by running ipconfig.
2. Test each interface in the list. Manually run a capture session with Wireshark using an interface from the list. 
3. On the host machine, Ping the target IPv4 (of the VM).
4. If the correct interface of the host is used, you’ll see the Ping request and reply packet exchanges through Wireshark,
5. Loop to step 2 and repeat, using another interface. 
=======

TIP: WireShark refers to the Libpcap filters as capture filters. Use the capture filters in Peach. Wireshark also defines its own display filters that it uses to filter entries in its 
session files. The display filters are not compatible with Libpcap.

====== Vmware (Windows virtual machine Automation)

The xref:Monitors_Vmware[Vmware] monitor controls setting up and starting the virtual machine and uses the settings in the following illustration:

image::{images}/Recipe_WindowsSvc_Vmware_Mon.png["VMWare Monitor", scale="50"]

The most significant parameters for the VMware monitor follow:

Vmx:: Identifies the full path of the virtual machine image. Peach loads the snapshot of the VM image at the start of the fuzzing job and after a fault occurs.

Headless:: Specifies whether the VM connects to a viewing window in the VMware window.  When developing a configuration, set this parameter to false. When performing a fuzzing job, the setting doesn't matter.

Host Type:: Specifies the VMWare product used in the configuration.

Snapshot Name:: Identifies the snapshot to use for the specific image.

===== PageHeap (Memory Heap Analyzer)

The xref:Monitors_PageHeap[PageHeap] monitor enables the Windows Debugger to analyze heap memory allocations throughout the fuzzing session. This monitor manages the registry entries that govern heap monitoring. The monitor sets the entries at the beginning of the fuzzing session and clears them at the end of the session. 

NOTE: PageHeap requires administrative privileges to run correctly.

The PageHeap monitor uses the settings in the following illustration:

image::{images}/Recipe_WindowsSvc_PageHeap_Mon.png["PageHeap Monitor", scale="50"]

The most significant parameters for the PageHeap monitor follow:

Executable name:: Name of the test target executable file. Provide the file name and extension. The path is not needed.

Win Dbg Path:: Folder on the test target containing the Windows debugging tools. Use absolute path from the file system root to the folder. 

IMPORTANT: When using PageHeap with Windows services, run the PageHeap monitor when the service is stopped.

===== WindowsService

The xref:Monitors_WindowsService[WindowsService] monitor manages a Windows service. This monitor starts the network service at the start of the fuzzing job, and restarts the service when the VM is refreshed (after a fault). The monitor is housed by the remote agent.

The WindowsService monitor uses the settings in the following illustration:

image::{images}/Recipe_WIndowsSvc_WinSvc_Mon.png["WindowsService Monitor", scale="50"]

The most significant parameter for the WindowsService monitor is “Service” that specifies the name of the Windows service to monitor.

===== WindowsDebugger

The xref:Monitors_WindowsDebugger[WindowsDebugger] debugger monitor performs two major functions in this recipe:

* Detects faults internal to the service.
* Create log files when a faulting condition occurs. 

The WindowsDebugger monitor uses the settings in the following illustration:

image::{images}/Recipe_WindowsSvc_WinDbg_Mon.png["WindowsDebugger Monitor", scale="50"]

The most significant paramters follow:

The most significant parameters for the WindowsDebugger monitor follow:

Service name:: Name of the test target service on the remote machine. Provide the service name given in the service properties.

Win Dbg Path:: Folder on the test target containing the Windows debugging tools. Use absolute path from the file system root to the folder. 
