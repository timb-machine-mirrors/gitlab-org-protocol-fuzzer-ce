<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://peachfuzzer.com/2012/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://peachfuzzer.com/2012/Peach /peach/peach.xsd">

	<Defaults>
		<Number size="8" signed="false" endian="little" />
	</Defaults>

	<DataModel name="SmbError">
		<Number name="ErrorClass" size="8" />
		<Number name="Reserved" size="8" />
		<Number name="ErrorCode" size="16" />
	</DataModel>
	
	<DataModel name="SmbHeader">
		<Blob name="Protocol" length="4" valueType="hex" value="\xff\x53\x4d\x42" />
		<Number name="Command" size="8" />
		<Block name="Status" ref="SmbError" />
		<Flags name="Flags" size="8">
			<Flag name="SMB_FLAGS_LOCK_AND_READ_OK" size="1" position="0"/>
			<Flag name="SMB_FLAGS_BUF_AVAIL" size="1" position="1"/>
			<Flag name="Reserved" size="1" position="2"/>
			<Flag name="SMB_FLAGS_CASE_INSENSITIVE" size="1" position="3" value="1"/>
			<Flag name="SMB_FLAGS_CANONICALIZED_PATHS" size="1" position="4" value="1"/>
			<Flag name="SMB_FLAGS_OPLOCK" size="1" position="5"/>
			<Flag name="SMB_FLAGS_OPBATCH" size="1" position="6"/>
			<Flag name="SMB_FLAGS_REPLY" size="1" position="7"/>
		</Flags>
		<Flags name="Flags2" size="16">
			<Flag name="SMB_FLAGS2_LONG_NAMES" size="1" position="0" value="1" />
			<Flag name="SMB_FLAGS2_EAS" size="1" position="1" value="1" />
			<Flag name="SMB_FLAGS2_SMB_SECURITY_SIGNATURE" size="2" position="3" value="1" />
			<Flag name="SMB_FLAGS2_IS_LONG_NAME" size="1" position="7" value="0" />
			<Flag name="SMB_FLAGS2_EXTENDEDSECURITY" size="11" position="3" value="1" />
			<Flag name="SMB_FLAGS2_DFS" size="1" position="12" value="0" />
			<Flag name="SMB_FLAGS2_PAGING_IO" size="1" position="13" value="0" />
			<Flag name="SMB_FLAGS2_NT_STATUS" size="1" position="14" value="1" />
			<Flag name="SMB_FLAGS2_UNICODE" size="1" position="15" value="1" />
		</Flags>
		<Number name="PIDHigh" size="16" />
		<Blob name="SecurityFeatures" length="8" />
		<Number name="Reserved" size="16" />
		<Number name="TID" size="16" value="3" />
		<Number name="PIDLow" size="16" value="4896" />
		<Number name="UID" size="16" value="100" />
		<Number name="MID" size="16" value="23169" />
	</DataModel>

	<DataModel name="SmbParameters">
		<Number name="WordCount" size="8">
			<Relation type="size" of="Words" expressionGet="size * 2" expressionSet="size / 2"/>
		</Number>
		<Blob name="Word" valueType="hex" value="00 00"/>
	</DataModel>

	<DataModel name="SmbData">
		<Number name="ByteCount" size="16">
			<Relation type="size" of="Bytes"/>
		</Number>
		<Blob name="Bytes" />
	</DataModel>

	<DataModel name="SMB_COM_TRANSACTION2">
		<Block name="Header" ref="SmbHeader">
			<Number name="Command" size="8" valueType="hex" value="0x32" />
		</Block>
		<Block name="Parameters" ref="SmbParameters">
			<Block name="Bytes">
				<Number name="TotalParameterCount" size="16" value="8" />
				<Number name="TotalDataCount" size="16" value="0" />
				<Number name="MaxParameterCount" size="16" value="2" />
				<Number name="MaxDataCount" size="16" value="40" />
				<Number name="MaxSetupCount" size="8" value="0" />
				<Number name="Reserved1" size="8" />
				<Number name="Flags" size="16" />
				<Number name="Timeout" size="32" />
				<Number name="Reserved2" size="16" />
				<Number name="ParameterCount" size="16">
					<Relation type="size" of="Trans2_Parameters"/>
				</Number>
				<Number name="ParameterOffset" size="16">
					<Relation type="offset" of="Trans2_Parameters" relative="true" relativeTo="Header"/>
				</Number>
				<Number name="DataCount" size="16">
					<Relation type="size" of="Trans2_Data"/>
				</Number>
				<Number name="DataOffset" size="16">
					<Relation type="offset" of="Trans2_Data" relative="true" relativeTo="Header"/>
				</Number>
				<Number name="SetupCount" size="8">
					<Relation type="size" of="Setup" expressionGet="size*2" expressionSet="size/2"/>
				</Number>
				<Number name="Reserved3" size="8" />
				<Blob name="Setup" value="0x0005"/> <!-- sub command -->
			</Block>
		</Block>
		
		<Block name="Data" ref="SmbData">
			<Block name="Bytes">
				<String name="Name" />
			</Block>
			<Padding name="Pad1" aligned="true" alignedTo="Header" alignment="4" />
			<Blob name="Trans2_Parameters" value="ec03000000000000"/>
			<Padding name="Pad2" aligned="true" alignedTo="Header" alignment="4" />
			<Blob name="Trans2_Data" />
		</Block>
	</DataModel>

	<DataModel name="Smb">
		
	</DataModel>
	
	<DataModel name="TcpTransportHeader">
		<Number size="8" value="8" />
		<Number size="32">
			<Relation type="size" of="Data" />
		</Number>
		<Block name="Data" ref="Smb" />
	</DataModel>

	<!-- TODO: Create state model -->
	<StateModel name="TheState" initialState="Initial">
		<State name="Initial">
			
			<Action type="output">
				<DataModel ref="TheDataModel"/>
				<!--<Data fileName="samples" />-->
			</Action>

			<!--<Action type="close"/>-->

			<!--<Action type="call" method="ScoobySnacks" publisher="Peach.Agent"/>-->
		</State>

	</StateModel>

	<!-- TODO: Configure Agent -->
	<Agent name="TheAgent">
		<!--<Monitor class="WindowsDebugger">
			<Param name="CommandLine" value="mspaint.exe fuzzed.png" />
			<Param name="WinDbgPath" value="C:\Program Files (x86)\Debugging Tools for Windows (x86)" />
			<Param name="StartOnCall" value="ScoobySnacks"/>
		</Monitor>
		<Monitor class="PageHeap">
			<Param name="Executable" value="mspaint.exe"/>
			<Param name="WinDbgPath" value="C:\Program Files (x86)\Debugging Tools for Windows (x86)" />
		</Monitor>-->
	</Agent>

	<Test name="TheTest">
		<Agent ref="TheAgent"/>
		<StateModel ref="TheState"/>

		<!-- TODO: Configure a publisher -->
		<!--<Publisher class="File">
			<Param name="FileName" value="peach.png"/>
		</Publisher>-->

		<!-- OPTIONAL: Configure a strategy -->
		<!--<Strategy class="Random"/>-->
		
		<Logger class="File">
			<Param name="Path" value="logs"/>
		</Logger>
	</Test>

</Peach>
<!-- end -->
