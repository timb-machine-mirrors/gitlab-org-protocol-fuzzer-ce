<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://peachfuzzer.com/2012/Peach"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://peachfuzzer.com/2012/Peach /peach/peach.xsd"
        author="Deja Vu Security, LLC"
        description="BGP4 PIT"
        version="0.0.1">

    <!-- Copyright (c) Deja Vu Security, LLC 2013 -->
    <!--
    <Include ns="States" src="file:##Path##/_Common/Models/Net/BGP_State.xml"/>
    -->

    <!-- TODO: Include Capability support
         https://www.iana.org/assignments/capability-codes/capability-codes.xhtml
    -->

    <!-- BEGIN BGP4 Packet Definition -->
    
    <DataModel name="BGP4">
        <!-- TODO: TCP-MD5 for auth https://tools.ietf.org/html/rfc2385 -->
        <Block name="BGP4Message">
            <Blob name="BGP4Marker" length="16" valueType="hex" token="true"
                value="FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF"/>
            <Number name="BGP4PacketLength" size="16" endian="big">
                <Relation type="size" of="BGP4Message"/>
            </Number>
            <Number name="BGP4Type" size="8"/>
            <Block name="BGP4Data"/>
        </Block>
    </DataModel>
    <!-- END BGP4 Packet Definition -->

    <!-- BEGIN BGP4 Update Message Definitions -->
    <DataModel name="BGP4RegularPathAttrib">
        <Block name="AttrType">
            <Block name="AttrFlags">
                <!-- NEED_DOC: Is position high or low order -->
                <Number name="Optional" size="1"/>
                <Number name="Transitive" size="1"/>
                <Number name="Partial" size="1"/>
                <Number name="ExtendedLength" size="1" constraint="int(value) == 0"/>
                <!--
                    If the Extended Length bit of the Attribute Flags octet is set
                    to 0, the third octet of the Path Attribute contains the length
                    of the attribute data in octets.
            
                    If the Extended Length bit of the Attribute Flags octet is set
                    to 1, the third and fourth octets of the path attribute contain
                    the length of the attribute data in octets.
                -->
                <Padding alignment="8"/>
            </Block>
            <Number name="AttrTypeCode" size="8"/>
        </Block>
        <Number name="AttrLength" size="8">
            <Relation type="size" of="AttrValue"/>
        </Number>
        <Blob name="AttrValue"/>
    </DataModel>

    <DataModel name="BGP4ExtendedPathAttrib">
        <Block name="AttrType">
            <Block name="AttrFlags"> 
                <!-- NEED_DOC: Is position high or low order -->
                <Number name="Optional" size="1"/>
                <Number name="Transitive" size="1"/>
                <Number name="Partial" size="1"/>
                <Number name="ExtendedLength" size="1" constraint="int(value) == 1"/>
                <!--
                    If the Extended Length bit of the Attribute Flags octet is set
                    to 0, the third octet of the Path Attribute contains the length
                    of the attribute data in octets.
            
                    If the Extended Length bit of the Attribute Flags octet is set
                    to 1, the third and fourth octets of the path attribute contain
                    the length of the attribute data in octets.
                -->
                <Padding alignment="8"/>
            </Block>
            <Number name="AttrTypeCode" size="8"/>
        </Block>
        <Number name="AttrLength" size="16">
            <Relation type="size" of="AttrValue"/>
        </Number>
        <Blob name="AttrValue"/>
    </DataModel>

    <DataModel name="BGP4PathAttrib">
        <!-- Ref: https://tools.ietf.org/html/rfc4271#section-5 -->
        <Block name="PathAttrib">
            <Choice name="PathAttribTypes">
                <Block name="ExtendedPathAttrib" ref="BGP4ExtendedPathAttrib"/>
                <Block name="RegularPathAttrib" ref="BGP4RegularPathAttrib"/>
            </Choice>
        </Block> 
    </DataModel>
    <!-- END BGP4 Update Message Definitions -->


    <!-- BEGIN BGP4 Message Types -->
    <DataModel name="BGP4Open" ref="BGP4">
        <!-- Ref: https://tools.ietf.org/html/rfc4271#section-4.2 -->
        <Number name="BGP4Message.BGP4Type" size="8" value="01"/>
        <Block name="BGP4Message.BGP4Data">
            <Number name="Version" size="8" value="4"/>
            <Number name="MyASN" size="16" endian="big" value="##MyASN##"/>
            <Number name="HoldTime" size="16" endian="big" value="##HoldTime##"/>
            <Number name="BGPIdentifier" size="32" endian="big" value="##BGPIdentifier##"/>
            <Number name="OptParamLen" size="8">
                <Relation type="size" of="BGP4OptParam"/>
            </Number>
            <Block name="BGP4OptParam" minOccurs="0" maxOccurs="-1">
                <Number name="ParamLength" size="8">
                    <Relation type="size" of="ParamValue"/>
                </Number>
                <Blob name="ParamValue"/>
            </Block>
        </Block>
    </DataModel>

    <DataModel name="BGP4Update" ref="BGP4">
        <!-- Ref: https://tools.ietf.org/html/rfc4271#section-4.3 -->
        <Number name="BGP4Message.BGP4Type" size="8" endian="big" value="02"/>
        <Block name="BGP4Message.BGP4Data">

            <Number name="WithdrawnRoutesLen" size="16" endian="big">
                <Relation type="size" of="WithdrawnRoutes"/>
            </Number>
            <Block name="WithdrawnRoutes" minOccurs="0" maxOccurs="-1">
                <Number name="WithdrawnLen" size="8">
                    <Relation type="count" of="WithdrawnPrefix"/>
                </Number>
                <Number name="WithdrawnPrefix" size="1" minOccurs="0" maxOccurs="255"/>
                <Padding alignment="8"/>
            </Block>

            <Number name="PathAttribLen" size="16" endian="big">
                <Relation type="size" of="PathAttribs"/>
            </Number>
            <!--TODO: Ensure that reference is proper -->
            <Block name="PathAttribs">
                <Block name="PathAttrib" ref="BGP4PathAttrib.PathAttrib"
                       minOccurs="0" maxOccurs="-1"/>
            </Block>

            <Block name="NetworkLayerReachability" minOccurs="0" maxOccurs="-1">
                <Number name="ReachabilityLen" size="8">
                    <!-- TESTCASE: Len is a maximum of 255, logical maximum: 32 -->
                    <Relation type="count" of="ReachabilityPrefix"/>
                </Number>
                <Number name="ReachabilityPrefix" size="1" minOccurs="0" maxOccurs="255"/>
                <Padding alignment="8"/>
            </Block>
        </Block>
    </DataModel>

    <DataModel name="BGP4Notification" ref="BGP4">
        <!-- Ref: https://tools.ietf.org/html/rfc4271#section-4.5 -->
        <Number name="BGP4Message.BGP4Type" size="8" value="03"/>
        <Block name="BGP4Message.BGP4Data">
            <Number name="ErrorCode" size="8"/>
            <Number name="ErrorSubCode" size="8"/>
            <Blob name="MessageData"/>
        </Block>
    </DataModel>

    <DataModel name="BGP4Keepalive" ref="BGP4">
        <!-- Ref: https://tools.ietf.org/html/rfc4271#section-4.4 -->
        <Number name="BGP4Message.BGP4Type" size="8" endian="big" value="04"/>
        <Block name="BGP4Message.BGP4Data">
            <!-- Purposefully Empty -->
        </Block>
    </DataModel>

    <DataModel name="BGP4RouteRefresh" ref="BGP4">
        <!-- Ref: https://tools.ietf.org/html/rfc2918 -->
        <Number name="BGP4Message.BGP4Type" size="8" endian="big" value="05"/>
        <Number name="AFI" size="16" endian="big"/>
        <Number name="reserved" size="8" value="0x00"/>
        <Number name="SAFI" size="8"/>
    </DataModel>
    <!-- END BGP4 Message Types -->
</Peach>
